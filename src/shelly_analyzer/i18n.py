from __future__ import annotations

from typing import Dict
from datetime import date as _date, datetime as _datetime


# Supported languages
LANGS = ("de", "en", "es", "fr", "pt", "it", "pl", "cs", "ru")


_I18N: Dict[str, Dict[str, str]] = {
    "de": {
        # App
        "app.title": "Shelly Energy Analyzer",

        # Generic
        "btn.apply": "Anwenden",
        "btn.reset": "Zurücksetzen",
        "common.from": "von",
        "common.to": "bis",
        "common.date_hint": "(YYYY-MM-DD oder TT.MM.JJJJ)",
        "common.custom": "Benutzerdefiniert",
        "common.minutes": "Minuten",
        "common.hours": "Stunden",
        "common.days": "Tage",

        # Top bar / tabs
        "ui.view": "Ansicht (max. 2 Geräte):",
        "tabs.sync": "Sync",
        "tabs.plots": "Plots",
        "tabs.live": "Live",
        "tabs.export": "Export",
        "tabs.settings": "Einstellungen",

        "tabs.setup": "Setup",

        # Setup wizard
        "setup.title": "Ersteinrichtung",
        "setup.subtitle": "Dieser Assistent hilft dir beim ersten Start: Geräte automatisch finden (mDNS/IP) und optional Telegram konfigurieren.",
        "setup.placeholder": "Bitte zuerst das Setup abschließen (mindestens ein Gerät hinzufügen). Danach werden diese Tabs aktiviert.",

        "setup.step.devices": "Geräte",
        "setup.step.telegram": "Telegram (optional)",
        "setup.step.finish": "Fertig",

        "setup.btn.back": "Zurück",
        "setup.btn.next": "Weiter",
        "setup.btn.finish": "Fertigstellen",

        "setup.devices.hint": "1) Suche Shelly-Geräte automatisch per mDNS (empfohlen) oder per IP-Scan im lokalen /24-Netz.\n2) Markiere gefundene Geräte und füge sie hinzu.\nDu kannst Namen/Keys später unter Einstellungen → Geräte anpassen.",
        "setup.devices.status.idle": "Bereit.",
        "setup.devices.status.mdns": "Suche per mDNS …",
        "setup.devices.status.ipscan": "Scanne Netzwerk {prefix}.0/24 …",
        "setup.devices.status.found": "{n} gefunden",
        "setup.devices.status.done": "Fertig: {n} gefunden",
        "setup.devices.status.mdns_err": "mDNS nicht verfügbar: {err}",

        "setup.devices.btn.mdns": "Automatisch finden (mDNS)",
        "setup.devices.btn.ipscan": "IP-Scan (/24)",
        "setup.devices.manual.label": "Manuell IP/Host:",
        "setup.devices.manual.btn.add": "Hinzufügen",
        "setup.devices.status.manual": "Prüfe {host} ...",
        "setup.devices.status.not_shelly": "Kein Shelly: {host}",

        "setup.devices.btn.add": "Ausgewählte hinzufügen",

        "setup.devices.col.host": "IP/Host",
        "setup.devices.col.model": "Modell",
        "setup.devices.col.kind": "Typ",
        "setup.devices.col.gen": "Gen",

        "setup.devices.add.ok": "{n} Gerät(e) hinzugefügt",
        "setup.devices.add.none": "Nichts ausgewählt",

        "setup.telegram.hint": "Telegram ist optional. Du kannst es auch später unter Einstellungen konfigurieren.",
        "setup.telegram.enable": "Telegram aktivieren",
        "setup.telegram.save": "Speichern",

        "setup.finish.hint": "Setup abgeschlossen. Du kannst jetzt Sync/Plots/Live nutzen.",
        "setup.finish.summary": "Geräte: {n}\nTipp: Öffne Einstellungen → Geräte, um Namen/Keys anzupassen.",
        "setup.finish.need_device": "Bitte zuerst mindestens ein Gerät hinzufügen (Schritt 1).",
        "tabs.billing": "Rechnung",

        # Sync tab
        "sync.header": "Sync (inkrementell oder fester Zeitraum)",
        "sync.btn.incremental": "Inkrementell",
        "sync.btn.day": "Tag",
        "sync.btn.week": "Woche",
        "sync.btn.month": "Monat",
        "sync.auto_live": "auto (Live)",
        "sync.from": "ab",
        "sync.startdate": "Startdatum",
        "sync.reload": "Daten neu laden",
        "autosync.active": "Aktiv",
        "autosync.interval": "Intervall:",
        "autosync.hours": "h",
        "autosync.mode": "Modus:",

        # Plots tab
        "plots.header": "Statistik (kWh) als Balkendiagramm",
        "plots.reload": "Neu laden",
        "plots.range": "Zeitraum für Plots (optional):",
        "plots.view": "Ansicht:",
        "plots.view.timeseries": "W/V/A (Zeitreihe)",
        "plots.view.kwh": "kWh (Balken)",
        "plots.kwh.granularity": "Statistik:",
        "plots.kwh.title": "Statistik (kWh)",
        "plots.view.energy": "kWh (Balken)",
        "plots.view.wva": "W/V/A (Zeitreihe)",
        "plots.wva.metric": "Messwert:",
        "plots.wva.window": "Fenster:",
        "plots.no_data": "(keine Daten)",
        "plots.no_data_va_hint": "(keine V/A Historie – bitte Live starten)",
        "plots.mode.all": "Alle",
        "plots.mode.days": "Tage",
        "plots.mode.weeks": "Wochen",
        "plots.mode.months": "Monate",
        "plots.mode.hours": "Stunden",
        "plots.kwh.last": "Letzte:",
        "plots.kwh.last_n": "Letzte {n} {unit}",

        # Plots (web/Plotly)
        "plots.web.header": "Plotly-Ansicht (Safari/Web)",
        "plots.web.open": "Im Browser öffnen",
        "plots.web.embed": "In App öffnen",
        "plots.web.hint": "Die interaktiven Plots werden als lokale Webseite gerendert (Plotly).\n\n- Browser: öffnet Safari (oder deinen Standardbrowser).\n- In App: optional (pywebview) – falls installiert.\n\nTipp: Dieser Modus skaliert sauber in Fullscreen/5K und benötigt kein Chrome.",
        "plots.web.no_server": "Web-Server konnte nicht gestartet werden.",
        "plots.web.window": "Plots",

        "btn.copy": "Kopieren",

        # Live tab
        "live.off": "Live ist aus.",
        "live.running": "Live läuft …",
        "live.start": "Live starten",
        "live.stop": "Stop",
        "live.freeze": "Freeze",
        "live.export_png": "Snapshot PNG",
        "live.polling_s": "Polling (s)",
        "live.window_min": "Ausschnitt (min)",
        "live.web": "Web",
        "live.update_s": "Update (s)",
        "live.qr.hint": "Hinweis: URL/QR erscheinen im Live-Tab.",
        "live.web_error": "Konnte Web-Dashboard nicht starten:",
        "live.cards.power": "Leistung",
        "live.cards.voltage": "Spannung",
        "live.cards.current": "Strom",
        "live.cards.kwh_today": "kWh heute",
        "live.cards.updated": "Update",
        "live.cards.switch": "Schalter",
        "live.switch.toggle": "Ein/Aus",
        "live.switch.on": "Ein",
        "live.switch.off": "Aus",
        "live.cards.switch": "Schalter",
        "live.switch.toggle": "Umschalten",
        "live.switch.on": "Ein",
        "live.switch.off": "Aus",
        "live.chart.power": "Leistung (W)",
        "live.chart.voltage": "Spannung (V) – L1/L2/L3",
        "live.chart.voltage.1p": "Spannung (V) – L1",
        "live.chart.current": "Strom (A) – L1/L2/L3",
        "live.chart.current.1p": "Strom (A) – L1",
        "live.time": "Zeit",

        # Export tab
        "export.dir": "Export-Ordner:",
        "export.range": "Zeitraum (optional, YYYY-MM-DD):",
        "export.invoice_period": "Rechnungszeitraum:",
        "export.anchor": "Stichtag (optional):",
        "export.btn.excel": "Excel exportieren",
        "export.btn.pdf_summary": "PDF Summary + Plots exportieren",
        "export.btn.invoices": "Rechnung (PDF) je Shelly",
        "export.btn.plots": "Plots exportieren (Days/Weeks/Months)",
        "export.btn.day_report_v1": "PDF Tagesreport (Var.1)",
        "export.btn.month_report_v1": "PDF Monatsreport (Var.1)",
        "export.btn.current_png": "Aktuelle Ansicht → PNG",
        "export.btn.current_pdf": "Aktuelle Ansicht → PDF",

        # Period labels
        "period.custom": "Benutzerdefiniert",
        "period.day": "Tag",
        "period.week": "Woche",
        "period.month": "Monat",
        "period.year": "Jahr",

        # Settings
        "settings.save": "Speichern",
        "settings.reload": "Config neu laden",
        "settings.saved": "Gespeichert: {path}",
        "settings.devices": "Geräte",
        "settings.main": "Live & Preis",
        "settings.advanced": "Erweitert",
        "settings.expert": "Experte",
        "settings.expert.note": "Alle config.json-Optionen sind hier editierbar. Änderungen sind mächtig – nutze Validieren/Backup.",
        "settings.download.title": "Download / Netzwerk",
        "settings.download.chunk_h": "Chunk (h):",
        "settings.download.overlap_s": "Overlap (s):",
        "settings.download.timeout_s": "Timeout (s):",
        "settings.download.retries": "Retries:",
        "settings.download.backoff": "Backoff:",
        "settings.download.note": "Hinweis: Änderungen wirken spätestens beim nächsten Sync.",
        "settings.csv_pack.title": "CSV Pack / Dateien",
        "settings.csv_pack.threshold": "Schwelle (# Dateien):",
        "settings.csv_pack.max_mb": "Max (MB):",
        "settings.csv_pack.remove_merged": "Merged-Dateien nach dem Packen entfernen",
        "settings.ui_advanced.title": "UI / Erweitert",
        "settings.ui_advanced.retention_min": "Retention (min, >=120):",
        "settings.ui_advanced.web_token": "Web Token:",
        "settings.ui_advanced.start_page": "Startseite (Ansicht):",
        "settings.ui_advanced.smoothing_enable": "Live Smoothing aktiv",
        "settings.ui_advanced.smoothing_seconds": "Smoothing (s):",
        "settings.ui_advanced.note": "Hinweis: Retention muss mind. 120 Minuten sein. Token schützt Web-Aktionen (optional).",
        "settings.raw.title": "Config (JSON)",
        "settings.raw.reload": "Vom Datenträger laden",
        "settings.raw.pretty": "Formatieren",
        "settings.raw.validate": "Validieren",
        "settings.raw.apply": "Übernehmen",
        "settings.raw.parse_error": "JSON-Fehler",
        "settings.raw.empty": "Editor ist leer.",
        "settings.raw.valid_ok": "Config ist gültig.",
        "settings.raw.invalid": "Config ungültig",
        "settings.raw.write_error": "Konnte config.json nicht schreiben",
        "settings.raw.reload_error": "Konnte config.json nicht laden",
        "settings.raw.pretty_ok": "JSON formatiert.",
                "settings.raw.applied": "Config übernommen: {path}",
        "settings.devices.hint": "(In App/Web werden immer nur 2 Geräte gleichzeitig angezeigt. Umschalten oben bei „Ansicht“.)",
        "settings.devices.key": "Key",
        "settings.devices.name": "Name",
        "settings.devices.host": "Host/IP",
        "settings.devices.emid": "EM ID",
        "settings.devices.model": "Modell",
        "settings.devices.kind": "Typ",
        "settings.device.add": "Hinzufügen",
        "settings.device.add_auto": "Per IP hinzufügen (Auto)",
        "settings.device.add_by_ip.title": "Gerät per IP hinzufügen",
        "settings.device.add_by_ip.ip": "IP/Host:",
        "settings.device.add_by_ip.name_optional": "Name (optional):",
        "settings.device.add_by_ip.probing": "Erkenne Gerät...",
        "settings.device.add_by_ip.failed": "Erkennung fehlgeschlagen",
        "settings.device.add_by_ip.add": "Hinzufügen",
        "settings.cancel": "Abbrechen",
        "settings.device.check_all": "Alle prüfen",
        "settings.device.check_all.running": "Geräte werden geprüft...",
        "settings.device.check_all.done": "Geräteprüfung abgeschlossen (bitte speichern)",

        "settings.mdns.title": "Gefundene Shellys (mDNS)",
        "settings.mdns.hint": "Klicke auf „Scan starten“, um Shellys im Netzwerk automatisch zu finden.",
        "settings.mdns.scan": "Scan starten",
        "settings.mdns.scanning": "Suche Shellys per mDNS…",
        "settings.mdns.failed": "mDNS-Scan fehlgeschlagen",
        "settings.mdns.none": "Keine Shellys gefunden.",
        "settings.mdns.found_n": "{n} Shellys gefunden.",
        "settings.mdns.add_selected": "Ausgewähltes Gerät hinzufügen",
        "settings.mdns.col_name": "Name",
        "settings.mdns.col_host": "IP",
        "settings.mdns.col_model": "Modell",
        "settings.mdns.col_gen": "Gen",
        "settings.mdns.col_service": "Service",

        "settings.health.title": "Geräte-Health / Netzwerkdiagnose",
        "settings.health.hint": "Klicke auf „Health-Check“, um TCP/HTTP-Latenz, Firmware und Live-Status zu prüfen.",
        "settings.health.run": "Health-Check",
        "settings.health.running": "Health-Check läuft…",
        "settings.health.done": "Health-Check fertig ({n} Geräte).",
        "settings.health.copy": "Kopieren",
        "settings.health.copied": "In die Zwischenablage kopiert.",
        "settings.health.nothing": "Noch keine Ergebnisse – erst Health-Check starten.",
        "settings.health.col_device": "Gerät",
        "settings.health.col_host": "IP",
        "settings.health.col_tcp": "TCP ms",
        "settings.health.col_http": "HTTP ms",
        "settings.health.col_model": "Modell",
        "settings.health.col_fw": "Firmware",
        "settings.health.col_last_ok": "Letzter OK",
        "settings.health.col_err_count": "Fehler",
        "settings.health.col_last_err": "Letzter Fehler",

        "settings.alerts.title": "Alarme",
        "settings.alerts.hint": "Einfache lokale Regeln: Wenn Messwert länger als Dauer über/unter Schwelle liegt, gibt’s Popup/Beep.",
        "settings.alerts.add": "Regel hinzufügen",
        "settings.alerts.remove": "Letzte Regel entfernen",
        "settings.alerts.col_id": "ID",
        "settings.alerts.col_enabled": "An",
        "settings.alerts.col_device": "Gerät",
        "settings.alerts.col_metric": "Messwert",
        "settings.alerts.col_op": "Op",
        "settings.alerts.col_threshold": "Schwelle",
        "settings.alerts.col_duration": "Dauer s",
        "settings.alerts.col_cooldown": "Cooldown s",
        "settings.alerts.col_popup": "Popup",
        "settings.alerts.col_beep": "Beep",
        "settings.alerts.col_telegram": "Telegram",
        "settings.alerts.device_all": "Alle Geräte",
        "settings.alerts.telegram.enabled": "Telegram aktiv",
        "settings.alerts.telegram.token": "Bot-Token",
        "settings.alerts.telegram.chat_id": "Chat-ID",
        "settings.alerts.telegram.verify_ssl": "SSL-Zertifikat prüfen",
        "settings.alerts.telegram.alarm_plots": "Alarm-Plots mitsenden (letzte 10 min)",
        "settings.alerts.telegram.detail": "Detailgrad",
        "settings.alerts.telegram.detail.simple": "Einfach",
        "settings.alerts.telegram.detail.detailed": "Detailliert",
        "settings.alerts.telegram.test": "Test senden",
        "settings.alerts.telegram.daily_summary": "Tägliche Zusammenfassung (Vortag)",
        "settings.alerts.telegram.daily_time": "Uhrzeit",
        "settings.alerts.telegram.daily_send_now": "Jetzt senden",
        "settings.alerts.telegram.monthly_summary": "Monats-Zusammenfassung (Vormonat)",
        "settings.alerts.telegram.summary_load_w": "Min. Last für VAR/cosφ (W)",
        "settings.alerts.telegram.monthly_time": "Uhrzeit",
        "settings.alerts.telegram.monthly_send_now": "Jetzt senden",
        "settings.alerts.col_message": "Text",
        "settings.alerts.fired": "{device}: {metric} {value:.2f} {op} {threshold:.2f}",
        "settings.alerts.confirm_delete_active": "Regel „{rule}“ ist aktiv. Wirklich löschen?",

        "settings.device.remove": "Gerät entfernen",
        "settings.device.remove.select": "Gerät wählen",
        "settings.device.remove.need_one": "Mindestens ein Gerät muss verbleiben.",
        "settings.device.removed.title": "Geräte entfernt",
        "settings.device.removed.archived": "Daten wurden nach 'data/deleted' verschoben:",
        "settings.device.removed.ask_archive": "Daten auch archivieren?\n\nJa = nach 'data/deleted' verschieben\nNein = Daten bleiben am Platz",
        "settings.language": "Sprache",
        "settings.language.de": "Deutsch",
        "settings.language.en": "Englisch",
        "settings.language.es": "Spanisch",
        "settings.language.fr": "Französisch",
        "settings.language.pt": "Portugiesisch",
        "settings.language.it": "Italienisch",
        "settings.language.pl": "Polnisch",
        "settings.language.cs": "Tschechisch",
        "settings.language.ru": "Russisch",

        # Settings: Pricing
        "settings.pricing.title": "Preis & MwSt",
        "settings.pricing.price": "Preis (€/kWh):",
        "settings.pricing.price_includes_vat": "Preis enthält MwSt (Brutto)",
        "settings.pricing.vat_enabled": "MwSt aktiv",
        "settings.pricing.vat_rate": "MwSt-Satz (%):",
        "settings.pricing.base_fee": "Grundpreis (€/Jahr):",
        "settings.pricing.base_fee_includes_vat": "Grundpreis enthält MwSt (Brutto)",

        # Settings: Autosync
        "settings.autosync.title": "Autosync",
        "settings.autosync.enabled": "Autosync aktiv",
        "settings.autosync.interval_h": "Intervall (h):",
        "settings.autosync.mode": "Modus:",

        # Settings: Live
        "settings.live.title": "Live Anzeige",
        "settings.live.polling": "Polling (s):",
        "settings.live.window": "Ausschnitt (min):",
        "settings.live.redraw": "Plot-Redraw (s):",
        "settings.live.note": "Hinweis: Änderungen wirken spätestens beim nächsten Live-Start.",

        # Settings: Web
        "settings.web.title": "Live-Web-Dashboard",
        "settings.web.enable": "Aktivieren",
        "settings.web.port": "Port:",
        "settings.web.update": "Update (s):",
        "settings.web.note": "Hinweis: URL/QR erscheinen im Live-Tab.",

        # Billing
        "billing.title": "Rechnungsdaten",
        "billing.issuer.title": "Absender / Firma",
        "billing.customer.title": "Kunde",
        "billing.invoice_settings.title": "Rechnungs-Einstellungen",
        "billing.field.name": "Name:",
        "billing.field.address": "Adresse:",
        "billing.field.vat_id": "USt-Id:",
        "billing.field.vat_id_optional": "USt-Id (optional):",
        "billing.field.email": "E-Mail:",
        "billing.field.phone": "Telefon:",
        "billing.field.iban": "IBAN:",
        "billing.field.bic": "BIC:",
        "billing.field.prefix": "Präfix:",
        "billing.field.payment_terms": "Zahlungsziel (Tage):",

        # Message titles
        "msg.settings": "Einstellungen",
        "msg.devices": "Geräte",
        "msg.sync": "Sync",
        "msg.export": "Export",
        "msg.data_load": "Daten laden",
        "msg.live_web": "Live Web Dashboard",

        # Message texts
        "sync.err.need_date": "Bitte ein Startdatum eingeben (TT.MM.JJJJ).",
        "sync.err.bad_date": "Ungültiges Datum: {s}. Format: TT.MM.JJJJ (z. B. 01.10.2025)",
        "sync.info.running": "Sync läuft bereits.",
        "sync.info.skipped_no_csv": "Übersprungen (kein CSV-Support; Live funktioniert weiterhin).",
        "export.no_data": "Keine Daten geladen.",
        "settings.need_device": "Mindestens ein Gerät muss konfiguriert sein.",
        "settings.reload.done": "Config neu geladen.",
        "settings.reload.note": "Bitte App neu starten, falls Live läuft.",

        # Misc / status messages
        "autosync.next_run": "Nächster Lauf: {nxt} ({interval_h}h)",
        "autosync.off": "Autosync: aus",
        "sync.err.generic": "Sync FEHLER: {e}",
        "log.open_error": "Konnte Log nicht öffnen:\n{e}",
        "live.smoothing": "Glätten",
        "live.daynight": "Tag/Nacht",
        "live.all": "Auto",
        "live.day": "Tag",
        "live.night": "Nacht",
        "live.open_log": "Log öffnen",
        "live.settings_saved": "Live-Einstellungen gespeichert.",
        "live.status.running_web": "Live läuft … Web: {url}",
        "live.status.web_error": "Live läuft … (Web-Fehler: {e})",
        "export.current_view_info": "Current View Export funktioniert aktuell für Live und Plots.",
        "export.current_view_exported": "Current View exportiert: {path}",
        "export.err.live_failed": "Live Export fehlgeschlagen: {e}",
        "export.err.plots_failed": "Plots Export fehlgeschlagen: {e}",
        "export.err.active_plot_tab": "Konnte aktiven Plot-Tab nicht ermitteln",
        "export.err.plots_notebook": "Plots-Notebook nicht verfügbar",
        "export.err.active_device": "Konnte aktives Gerät im Plot nicht ermitteln",
        "export.err.figure_unavailable": "Plot-Figure nicht verfügbar (bitte einmal neu zeichnen)",

        # Web: Live dashboard
        "web.live.title": "Shelly Live Dashboard",
        "web.live.meta_refresh": "Aktualisierung: alle",
        "web.nav.live": "Live",
        "web.nav.control": "Steuerung",
        "web.pill.window": "Ausschnitt",
        "web.pill.url": "URL",
        "web.chart.power": "Leistung (W)",
        "web.chart.voltage": "Spannung (V) – L1/L2/L3",
        "web.chart.voltage.1p": "Spannung (V) – L1",
        "web.chart.current": "Strom (A) – L1/L2/L3",
        "web.chart.current.1p": "Strom (A) – L1",
        "web.kv.power": "Leistung",
        "web.kv.kwh_today": "kWh heute",
        "web.kv.u": "U",
        "web.kv.i": "I",
        "web.kv.var": "Blindleistung",
        "web.kv.cosphi": "cos φ",
        "web.switch": "Schalter",
        "web.switch.toggle": "Umschalten",
        "web.switch.on": "Ein",
        "web.switch.off": "Aus",
        "web.theme.dark": "Dunkelmodus",
        "web.theme.light": "Hellmodus",
        "web.btn.theme": "Tag/Nacht",
        "web.btn.refresh": "Aktualisieren",
        "web.btn.autorefresh": "Auto",
        "web.autorefresh.on": "Auto-Refresh: An",
        "web.autorefresh.off": "Auto-Refresh: Aus",
        "web.freeze": "Freeze",
        "web.freeze.on": "Freeze: An",
        "web.freeze.off": "Freeze: Aus",

        # Web: Control page
        "web.control.title": "Shelly Steuerung",
        "web.control.meta": "Von hier kannst du Sync/Plots/Exports starten.",
        "web.control.sync": "Sync",
        "web.control.plots": "Plots",
        "web.control.open_plotly": "Interaktive Plots öffnen",

        # Web: Plotly plots page
        "web.plots.title": "Plots",
        "web.loading": "Lade…",
        "web.error": "Fehler",
        "web.unknown": "unbekannt",
        "web.axis.time": "Zeit",
        "web.plots.view": "Ansicht",
        "web.plots.metric": "Messwert",
        "web.plots.kwh_mode": "Statistik",
        "web.plots.range": "Zeitraum",
        "web.plots.devices": "Geräte (max. 2)",
        "web.plots.max2": "max. 2 Geräte",
        "web.plots.no_devices": "Keine Geräte konfiguriert",
        "web.plots.no_data": "Keine Daten gefunden",
        "web.plots.series": "Serie",
        "web.plots.series.total": "Gesamt",
        "web.plots.series.phases": "Phasen (L1/L2/L3)",
        "web.plots.filter.smooth": "Glättung (s)",
        "web.plots.filter.deadband": "Deadband (VAR)",
        "web.plots.filter.signhold": "Vorzeichen-Hold (s)",
        "web.control.export": "Export",
        "web.control.jobs": "Jobs",
        "web.control.mode": "Modus",
        "web.control.start": "Start (TT.MM.JJJJ)",
        "web.control.btn.sync": "Sync starten",
        "web.control.plots.from": "von",
        "web.control.plots.to": "bis",
        "web.control.btn.plots": "Plots erzeugen",
        "web.control.invoice": "Rechnung",
        "web.control.anchor": "Anker",
        "web.control.custom_note": "(bei custom werden von/bis genutzt)",
        "web.control.btn.pdf": "PDF Summary + Plots",
        "web.control.btn.invoices": "Rechnungen je Shelly",
        "web.control.btn.bundle": "ZIP Bundle (48h)",
        "web.control.btn.report_day": "Report (Tag)",
        "web.control.btn.report_month": "Report (Monat)",
        "web.control.jobs.meta": "Letzte Aktionen (Browser ↔ App). Aktualisiert automatisch.",

        # Web: Token / errors
        "web.token.denied_title": "Zugriff verweigert",
        "web.token.protected": "Diese Seite ist mit einem Token geschützt. Bitte öffne die URL aus der Desktop-App (inkl. ?t=…) oder füge hier das Token ein.",
        "web.token.placeholder": "Token (z.B. a1b2c3d4)",
        "web.token.open": "Öffnen",
        "web.token.tip": "Tipp: In der App wird die vollständige URL angezeigt und als QR-Code bereitgestellt.",
        "web.err.start_command": "Bitte start.command ausführen.",
        "web.err.plotly_timeout": "Plotly konnte nicht geladen werden. Bitte start.command ausführen (installiert plotly) oder /static/plotly.min.js prüfen.",
        "first_run.hint": "Willkommen! Bitte zuerst deine Shelly-Geräte hinzufügen/prüfen und dann speichern. Solange keine Geräte konfiguriert sind, werden keine CSVs geladen und es erscheinen keine Warn-Popups.",
        "first_run.status": "Erster Start: Bitte Geräte in Einstellungen → Geräte konfigurieren und speichern.",
  "demo.device.house_3p": "Demo Haus (3-phasig)",
  "demo.device.garage_1p": "Demo Garage (1-phasig)",
  "demo.mode.active": "DEMO MODE aktiv — es werden keine echten Geräte genutzt",
    "settings.updates": "Updates",
    "updates.status.idle": "Bereit.",
    "updates.status.checking": "Prüfe auf Updates…",
    "updates.status.unreachable": "GitHub nicht erreichbar (offline/Timeout).",
    "updates.status.none": "Keine Updates verfügbar.",
    "updates.status.available": "Update verfügbar: {tag}",
    "updates.check_now": "Jetzt prüfen",
    "updates.install": "Download & installieren",
    "updates.auto": "Updates beim Start automatisch installieren",
    "updates.open_release": "Release-Seite öffnen",
    "updates.title": "Updates",
    "updates.download_install": "Download & installieren",
    "updates.auto_install": "Updates beim Start automatisch installieren",
    "updates.searching": "Suche nach Updates…",
    "updates.downloading": "Update wird vorbereitet…",
    "updates.opened_browser": "Release-Seite im Browser geöffnet.",
    "updates.open_failed": "Browser konnte nicht geöffnet werden",
    "updates.not_checked": "(noch nicht geprüft)",
    "updates.save_failed": "Konfiguration konnte nicht gespeichert werden",
    "updates.available": "Update verfügbar",
    "updates.none": "Kein Update gefunden",
    "updates.no_download": "Kein Download verfügbar. Bitte zuerst „Jetzt prüfen“.",
    "updates.failed": "Update fehlgeschlagen",
    },
    "en": {
        # App
        "app.title": "Shelly Energy Analyzer",

        # Generic
        "btn.apply": "Apply",
        "btn.reset": "Reset",
        "common.from": "from",
        "common.to": "to",
        "common.date_hint": "(YYYY-MM-DD or DD.MM.YYYY)",
        "common.custom": "Custom",
        "common.minutes": "minutes",
        "common.hours": "hours",
        "common.days": "days",

        # Top bar / tabs
        "ui.view": "View (max. 2 devices):",
        "tabs.sync": "Sync",
        "tabs.plots": "Charts",
        "tabs.live": "Live",
        "tabs.export": "Export",
        "tabs.settings": "Settings",

        "tabs.setup": "Setup",

        # Setup wizard
        "setup.title": "First-time setup",
        "setup.subtitle": "This wizard helps you get started: auto-discover Shelly devices (mDNS/IP) and optionally configure Telegram.",
        "setup.placeholder": "Please complete the setup first (add at least one device). These tabs will be enabled afterwards.",

        "setup.step.devices": "Devices",
        "setup.step.telegram": "Telegram (optional)",
        "setup.step.finish": "Finish",

        "setup.btn.back": "Back",
        "setup.btn.next": "Next",
        "setup.btn.finish": "Finish",

        "setup.devices.hint": "1) Discover Shelly devices via mDNS (recommended) or by scanning your local /24 subnet.\n2) Select found devices and add them.\nYou can adjust names/keys later in Settings → Devices.",
        "setup.devices.status.idle": "Ready.",
        "setup.devices.status.mdns": "Discovering via mDNS …",
        "setup.devices.status.ipscan": "Scanning network {prefix}.0/24 …",
        "setup.devices.status.found": "{n} found",
        "setup.devices.status.done": "Done: {n} found",
        "setup.devices.status.mdns_err": "mDNS not available: {err}",

        "setup.devices.btn.mdns": "Auto-discover (mDNS)",
        "setup.devices.btn.ipscan": "IP scan (/24)",
        "setup.devices.manual.label": "Manual IP/Host:",
        "setup.devices.manual.btn.add": "Add",
        "setup.devices.status.manual": "Probing {host} ...",
        "setup.devices.status.not_shelly": "Not a Shelly: {host}",

        "setup.devices.btn.add": "Add selected",

        "setup.devices.col.host": "IP/Host",
        "setup.devices.col.model": "Model",
        "setup.devices.col.kind": "Type",
        "setup.devices.col.gen": "Gen",

        "setup.devices.add.ok": "Added {n} device(s)",
        "setup.devices.add.none": "Nothing selected",

        "setup.telegram.hint": "Telegram is optional. You can also configure it later in Settings.",
        "setup.telegram.enable": "Enable Telegram",
        "setup.telegram.save": "Save",

        "setup.finish.hint": "Setup complete. You can now use Sync/Plots/Live.",
        "setup.finish.summary": "Devices: {n}\nTip: Open Settings → Devices to adjust names/keys.",
        "setup.finish.need_device": "Please add at least one device first (Step 1).",
        "tabs.billing": "Invoice",

        # Sync tab
        "sync.header": "Sync (incremental or fixed range)",
        "sync.btn.incremental": "Incremental",
        "sync.btn.day": "Day",
        "sync.btn.week": "Week",
        "sync.btn.month": "Month",
        "sync.auto_live": "auto (Live)",
        "sync.from": "from",
        "sync.startdate": "Start date",
        "sync.reload": "Reload data",
        "autosync.active": "Enabled",
        "autosync.interval": "Interval:",
        "autosync.hours": "h",
        "autosync.mode": "Mode:",

        # Plots tab
        "plots.header": "Statistics (kWh) as bar chart",
        "plots.reload": "Reload",
        "plots.range": "Plot range (optional):",
        "plots.view": "View:",
        "plots.view.timeseries": "W/V/A (time series)",
        "plots.view.kwh": "kWh (bars)",
        "plots.kwh.granularity": "Statistics:",
        "plots.kwh.title": "Statistics (kWh)",
        "plots.view.energy": "kWh (bars)",
        "plots.view.wva": "W/V/A (time series)",
        "plots.wva.metric": "Metric:",
        "plots.wva.window": "Window:",
        "plots.no_data": "(no data)",
        "plots.no_data_va_hint": "(no V/A history – start Live)",
        "plots.mode.all": "All",
        "plots.mode.days": "Days",
        "plots.mode.weeks": "Weeks",
        "plots.mode.months": "Months",
        "plots.mode.hours": "Hours",
        "plots.kwh.last": "Last:",
        "plots.kwh.last_n": "Last {n} {unit}",

        # Plots (web/Plotly)
        "plots.web.header": "Plotly view (Safari/Web)",
        "plots.web.open": "Open in browser",
        "plots.web.embed": "Open in app",
        "plots.web.hint": "Interactive plots are rendered as a local web page (Plotly).\n\n- Browser: opens Safari (or your default browser).\n- In App: optional (pywebview) – if installed.\n\nTip: This mode scales correctly in fullscreen/5K and does not require Chrome.",
        "plots.web.no_server": "Could not start the web server.",
        "plots.web.window": "Plots",

        "btn.copy": "Copy",

        # Live tab
        "live.off": "Live is off.",
        "live.running": "Live running …",
        "live.start": "Start Live",
        "live.stop": "Stop",
        "live.freeze": "Freeze",
        "live.export_png": "Snapshot PNG",
        "live.polling_s": "Polling (s)",
        "live.window_min": "Window (min)",
        "live.web": "Web",
        "live.update_s": "Update (s)",
        "live.qr.hint": "Note: URL/QR will appear in the Live tab.",
        "live.web_error": "Could not start web dashboard:",
        "live.cards.power": "Power",
        "live.cards.voltage": "Voltage",
        "live.cards.current": "Current",
        "live.cards.kwh_today": "kWh today",
        "live.cards.updated": "Updated",
        "live.cards.switch": "Switch",
        "live.switch.toggle": "Toggle",
        "live.switch.on": "On",
        "live.switch.off": "Off",
        "live.cards.switch": "Switch",
        "live.switch.toggle": "Toggle",
        "live.switch.on": "On",
        "live.switch.off": "Off",
        "live.chart.power": "Power (W)",
        "live.chart.voltage": "Voltage (V) – L1/L2/L3",
        "live.chart.voltage.1p": "Voltage (V) – L1",
        "live.chart.current": "Current (A) – L1/L2/L3",
        "live.chart.current.1p": "Current (A) – L1",
        "live.time": "Time",

        # Export tab
        "export.dir": "Export folder:",
        "export.range": "Range (optional, YYYY-MM-DD):",
        "export.invoice_period": "Invoice period:",
        "export.anchor": "Anchor date (optional):",
        "export.btn.excel": "Export Excel",
        "export.btn.pdf_summary": "Export PDF summary + plots",
        "export.btn.invoices": "Invoices (PDF) per Shelly",
        "export.btn.plots": "Export plots (days/weeks/months)",
        "export.btn.day_report_v1": "PDF day report (v1)",
        "export.btn.month_report_v1": "PDF month report (v1)",
        "export.btn.current_png": "Current view → PNG",
        "export.btn.current_pdf": "Current view → PDF",

        # Period labels
        "period.custom": "Custom",
        "period.day": "Day",
        "period.week": "Week",
        "period.month": "Month",
        "period.year": "Year",
        "export.btn.current_png": "Current view → PNG",
        "export.btn.current_pdf": "Current view → PDF",

        # Period labels
        "period.custom": "Custom",
        "period.day": "Day",
        "period.week": "Week",
        "period.month": "Month",
        "period.year": "Year",

        # Settings
        "settings.save": "Save",
        "settings.reload": "Reload config",
        "settings.saved": "Saved: {path}",
        "settings.devices": "Devices",
        "settings.main": "Live & Pricing",
        "settings.advanced": "Advanced",
        "settings.expert": "Expert",
        "settings.expert.note": "All config.json options are editable here. Powerful – use Validate/Backup.",
        "settings.download.title": "Download / Network",
        "settings.download.chunk_h": "Chunk (h):",
        "settings.download.overlap_s": "Overlap (s):",
        "settings.download.timeout_s": "Timeout (s):",
        "settings.download.retries": "Retries:",
        "settings.download.backoff": "Backoff:",
        "settings.download.note": "Note: Changes take effect at the next sync.",
        "settings.csv_pack.title": "CSV Pack / Files",
        "settings.csv_pack.threshold": "Threshold (# files):",
        "settings.csv_pack.max_mb": "Max (MB):",
        "settings.csv_pack.remove_merged": "Remove merged files after packing",
        "settings.ui_advanced.title": "UI / Advanced",
        "settings.ui_advanced.retention_min": "Retention (min, >=120):",
        "settings.ui_advanced.web_token": "Web token:",
        "settings.ui_advanced.start_page": "Start page (view):",
        "settings.ui_advanced.smoothing_enable": "Enable live smoothing",
        "settings.ui_advanced.smoothing_seconds": "Smoothing (s):",
        "settings.ui_advanced.note": "Note: Retention must be at least 120 minutes. Token optionally protects web actions.",
        "settings.raw.title": "Config (JSON)",
        "settings.raw.reload": "Reload from disk",
        "settings.raw.pretty": "Format",
        "settings.raw.validate": "Validate",
        "settings.raw.apply": "Apply",
        "settings.raw.parse_error": "JSON error",
        "settings.raw.empty": "Editor is empty.",
        "settings.raw.valid_ok": "Config is valid.",
        "settings.raw.invalid": "Config invalid",
        "settings.raw.write_error": "Could not write config.json",
        "settings.raw.reload_error": "Could not load config.json",
        "settings.raw.pretty_ok": "JSON formatted.",
        "settings.raw.applied": "Config applied: {path}",
        "settings.devices.hint": "(The app/web shows 2 devices at a time. Switch at the top via “View”.)",
        "settings.devices.key": "Key",
        "settings.devices.name": "Name",
        "settings.devices.host": "Host/IP",
        "settings.devices.emid": "EM ID",
        "settings.devices.model": "Model",
        "settings.devices.kind": "Type",
        "settings.device.add": "Add",
        "settings.device.add_auto": "Add by IP (Auto)",
        "settings.device.add_by_ip.title": "Add device by IP",
        "settings.device.add_by_ip.ip": "IP/Host:",
        "settings.device.add_by_ip.name_optional": "Name (optional):",
        "settings.device.add_by_ip.probing": "Probing device...",
        "settings.device.add_by_ip.failed": "Probe failed",
        "settings.device.add_by_ip.add": "Add",
        "settings.cancel": "Cancel",
        "settings.device.check_all": "Check all",
        "settings.device.check_all.running": "Checking devices...",
        "settings.device.check_all.done": "Device check finished (please save)",

        "settings.mdns.title": "Discovered Shellys (mDNS)",
        "settings.mdns.hint": "Click “Start scan” to discover Shelly devices on your network.",
        "settings.mdns.scan": "Start scan",
        "settings.mdns.scanning": "Scanning for Shelly devices via mDNS…",
        "settings.mdns.failed": "mDNS scan failed",
        "settings.mdns.none": "No Shelly devices found.",
        "settings.mdns.found_n": "Found {n} Shelly devices.",
        "settings.mdns.add_selected": "Add selected device",
        "settings.mdns.col_name": "Name",
        "settings.mdns.col_host": "IP",
        "settings.mdns.col_model": "Model",
        "settings.mdns.col_gen": "Gen",
        "settings.mdns.col_service": "Service",

        "settings.health.title": "Device health / network diagnostics",
        "settings.health.hint": "Click “Health check” to measure TCP/HTTP latency, firmware and live status.",
        "settings.health.run": "Health check",
        "settings.health.running": "Running health check…",
        "settings.health.done": "Health check done ({n} devices).",
        "settings.health.copy": "Copy",
        "settings.health.copied": "Copied to clipboard.",
        "settings.health.nothing": "No results yet – run the health check first.",
        "settings.health.col_device": "Device",
        "settings.health.col_host": "IP",
        "settings.health.col_tcp": "TCP ms",
        "settings.health.col_http": "HTTP ms",
        "settings.health.col_model": "Model",
        "settings.health.col_fw": "Firmware",
        "settings.health.col_last_ok": "Last OK",
        "settings.health.col_err_count": "Errors",
        "settings.health.col_last_err": "Last error",

        "settings.alerts.title": "Alerts",
        "settings.alerts.hint": "Simple local rules: if a metric stays above/below a threshold for a duration, show popup/beep.",
        "settings.alerts.add": "Add rule",
        "settings.alerts.remove": "Remove last rule",
        "settings.alerts.col_id": "ID",
        "settings.alerts.col_enabled": "On",
        "settings.alerts.col_device": "Device",
        "settings.alerts.col_metric": "Metric",
        "settings.alerts.col_op": "Op",
        "settings.alerts.col_threshold": "Threshold",
        "settings.alerts.col_duration": "Duration s",
        "settings.alerts.col_cooldown": "Cooldown s",
        "settings.alerts.col_popup": "Popup",
        "settings.alerts.col_beep": "Beep",
        "settings.alerts.col_telegram": "Telegram",
        "settings.alerts.device_all": "All devices",
        "settings.alerts.telegram.enabled": "Enable Telegram",
        "settings.alerts.telegram.token": "Bot token",
        "settings.alerts.telegram.chat_id": "Chat ID",
        "settings.alerts.telegram.verify_ssl": "Verify SSL certificate",
        "settings.alerts.telegram.alarm_plots": "Include alarm plots (last 10 min)",
        "settings.alerts.telegram.test": "Send test",
        "settings.alerts.telegram.daily_summary": "Daily summary (previous day)",
        "settings.alerts.telegram.daily_time": "Time",
        "settings.alerts.telegram.daily_send_now": "Send now",
        "settings.alerts.telegram.monthly_summary": "Monthly summary (previous month)",
        "settings.alerts.telegram.summary_load_w": "Min load for VAR/cosφ (W)",
        "settings.alerts.telegram.monthly_time": "Time",
        "settings.alerts.telegram.monthly_send_now": "Send now",
        "settings.alerts.col_message": "Message",
        "settings.alerts.fired": "{device}: {metric} {value:.2f} {op} {threshold:.2f}",
        "settings.alerts.confirm_delete_active": "Rule \"{rule}\" is active. Delete anyway?",

        "settings.device.remove": "Remove device",
        "settings.device.remove.select": "Select device",
        "settings.device.remove.need_one": "At least one device must remain.",
        "settings.device.removed.title": "Devices removed",
        "settings.device.removed.archived": "Data was moved to 'data/deleted':",
        "settings.device.removed.ask_archive": "Archive data as well?\n\nYes = move to 'data/deleted'\nNo = keep data in place",
        "settings.language": "Language",
        "settings.language.de": "German",
        "settings.language.en": "English",
        "settings.language.es": "Spanish",
        "settings.language.fr": "French",
        "settings.language.pt": "Portuguese",
        "settings.language.it": "Italian",
        "settings.language.pl": "Polish",
        "settings.language.cs": "Czech",
        "settings.language.ru": "Russian",

        # Settings: Pricing
        "settings.pricing.title": "Pricing & VAT",
        "settings.pricing.price": "Price (€/kWh):",
        "settings.pricing.price_includes_vat": "Price includes VAT (gross)",
        "settings.pricing.vat_enabled": "VAT enabled",
        "settings.pricing.vat_rate": "VAT rate (%):",
        "settings.pricing.base_fee": "Base fee (€/year):",
        "settings.pricing.base_fee_includes_vat": "Base fee includes VAT (gross)",

        # Settings: Autosync
        "settings.autosync.title": "Autosync",
        "settings.autosync.enabled": "Autosync enabled",
        "settings.autosync.interval_h": "Interval (h):",
        "settings.autosync.mode": "Mode:",

        # Settings: Live
        "settings.live.title": "Live display",
        "settings.live.polling": "Polling (s):",
        "settings.live.window": "Window (min):",
        "settings.live.redraw": "Plot redraw (s):",
        "settings.live.note": "Note: changes apply at the latest when Live is started again.",

        # Settings: Web
        "settings.web.title": "Live web dashboard",
        "settings.web.enable": "Enable",
        "settings.web.port": "Port:",
        "settings.web.update": "Update (s):",
        "settings.web.note": "Note: URL/QR will appear in the Live tab.",

        # Billing
        "billing.title": "Invoice data",
        "billing.issuer.title": "Issuer / Company",
        "billing.customer.title": "Customer",
        "billing.invoice_settings.title": "Invoice settings",
        "billing.field.name": "Name:",
        "billing.field.address": "Address:",
        "billing.field.vat_id": "VAT ID:",
        "billing.field.vat_id_optional": "VAT ID (optional):",
        "billing.field.email": "Email:",
        "billing.field.phone": "Phone:",
        "billing.field.iban": "IBAN:",
        "billing.field.bic": "BIC:",
        "billing.field.prefix": "Prefix:",
        "billing.field.payment_terms": "Payment terms (days):",

        # Message titles
        "msg.settings": "Settings",
        "msg.devices": "Devices",
        "msg.sync": "Sync",
        "msg.export": "Export",
        "msg.data_load": "Load data",
        "msg.live_web": "Live Web Dashboard",

        # Message texts
        "sync.err.need_date": "Please enter a start date (DD.MM.YYYY).",
        "sync.err.bad_date": "Invalid date: {s}. Format: DD.MM.YYYY (e.g. 01.10.2025)",
        "sync.info.running": "Sync is already running.",
        "sync.info.skipped_no_csv": "Skipped (no CSV support; Live still works).",
        "export.no_data": "No data loaded.",
        "settings.need_device": "At least one device must be configured.",
        "settings.reload.done": "Config reloaded.",
        "settings.reload.note": "Please restart the app if Live is running.",

        # Misc / status messages
        "autosync.next_run": "Next run: {nxt} ({interval_h}h)",
        "autosync.off": "Autosync: off",
        "sync.err.generic": "Sync ERROR: {e}",
        "log.open_error": "Could not open log:\n{e}",
        "live.smoothing": "Smoothing",
        "live.daynight": "Day/Night",
        "live.all": "Auto",
        "live.day": "Day",
        "live.night": "Night",
        "live.open_log": "Open log",
        "live.settings_saved": "Live settings saved.",
        "live.status.running_web": "Live running … Web: {url}",
        "live.status.web_error": "Live running … (web error: {e})",
        "export.current_view_info": "Current View export works for Live and Charts.",
        "export.current_view_exported": "Current View exported: {path}",
        "export.err.live_failed": "Live export failed: {e}",
        "export.err.plots_failed": "Charts export failed: {e}",
        "export.err.active_plot_tab": "Could not determine active chart tab",
        "export.err.plots_notebook": "Charts notebook not available",
        "export.err.active_device": "Could not determine active device in chart",
        "export.err.figure_unavailable": "Chart figure not available (please redraw once)",

        # Web: Live dashboard
        "web.live.title": "Shelly Live Dashboard",
        "web.live.meta_refresh": "Refresh: every",
        "web.nav.live": "Live",
        "web.nav.control": "Control",
        "web.pill.window": "Window",
        "web.pill.url": "URL",
        "web.chart.power": "Power (W)",
        "web.chart.voltage": "Voltage (V) – L1/L2/L3",
        "web.chart.voltage.1p": "Voltage (V) – L1",
        "web.chart.current": "Current (A) – L1/L2/L3",
        "web.chart.current.1p": "Current (A) – L1",
        "web.kv.power": "Power",
        "web.kv.kwh_today": "kWh today",
        "web.kv.u": "U",
        "web.kv.i": "I",
        "web.kv.var": "Reactive power",
        "web.kv.cosphi": "cos φ",
        "web.switch": "Switch",
        "web.switch.toggle": "Toggle",
        "web.switch.on": "On",
        "web.switch.off": "Off",
        "web.theme.dark": "Dark mode",
        "web.theme.light": "Light mode",
        "web.btn.theme": "Theme",
        "web.btn.refresh": "Refresh",
        "web.btn.autorefresh": "Auto",
        "web.autorefresh.on": "Auto refresh: on",
        "web.autorefresh.off": "Auto refresh: off",
        "web.freeze": "Freeze",
        "web.freeze.on": "Freeze: on",
        "web.freeze.off": "Freeze: off",

        # Web: Control page
        "web.control.title": "Shelly Control",
        "web.control.meta": "Start sync/plots/exports from here.",
        "web.control.sync": "Sync",
        "web.control.plots": "Charts",
        "web.control.open_plotly": "Open interactive plots",

        "web.plots.title": "Plots",
        "web.loading": "Loading…",
        "web.error": "Error",
        "web.unknown": "unknown",
        "web.axis.time": "Time",
        "web.plots.view": "View",
        "web.plots.metric": "Metric",
        "web.plots.kwh_mode": "Mode",
        "web.plots.range": "Range",
        "web.plots.devices": "Devices (max. 2)",
        "web.plots.max2": "max. 2 devices",
        "web.plots.no_devices": "No devices configured",
        "web.plots.no_data": "No data found",
        "web.plots.series": "Series",
        "web.plots.series.total": "Total",
        "web.plots.series.phases": "Phases (L1/L2/L3)",
        "web.plots.filter.smooth": "Smoothing (s)",
        "web.plots.filter.deadband": "Deadband (VAR)",
        "web.plots.filter.signhold": "Sign hold (s)",

        "web.control.export": "Export",
        "web.control.jobs": "Jobs",



        "web.control.mode": "Mode",
        "web.control.start": "Start (DD.MM.YYYY)",
        "web.control.btn.sync": "Start sync",
        "web.control.plots.from": "from",
        "web.control.plots.to": "to",
        "web.control.btn.plots": "Generate plots",
        "web.control.invoice": "Invoice",
        "web.control.anchor": "Anchor",
        "web.control.custom_note": "(for custom, from/to are used)",
        "web.control.btn.pdf": "PDF summary + plots",
        "web.control.btn.invoices": "Invoices per Shelly",
        "web.control.btn.bundle": "ZIP bundle (48h)",
        "web.control.btn.report_day": "Report (day)",
        "web.control.btn.report_month": "Report (month)",
        "web.control.jobs.meta": "Latest actions (browser ↔ app). Auto-refresh.",

        # Web: Token / errors
        "web.token.denied_title": "Access denied",
        "web.token.protected": "This page is protected by a token. Please open the URL from the desktop app (incl. ?t=...) or paste the token here.",
        "web.token.placeholder": "Token (e.g. a1b2c3d4)",
        "web.token.open": "Open",
        "web.token.tip": "Tip: The desktop app shows the full URL and provides it as a QR code.",
        "web.err.start_command": "Please run start.command.",
        "web.err.plotly_timeout": "Plotly could not be loaded. Please run start.command (installs plotly) or check /static/plotly.min.js.",
        "first_run.hint": "Welcome! Please add/verify your Shelly devices first and click Save. While no devices are configured, the app will not load CSVs and will stay quiet (no warning popups).",
        "first_run.status": "First run: configure devices in Settings → Devices and click Save.",
  "demo.device.house_3p": "Demo House (3-phase)",
  "demo.device.garage_1p": "Demo Garage (1-phase)",
  "demo.mode.active": "DEMO MODE active — no real devices are used",
    "settings.updates": "Updates",
    "updates.status.idle": "Ready.",
    "updates.status.checking": "Checking for updates…",
    "updates.status.unreachable": "GitHub not reachable (offline/timeout).",
    "updates.status.none": "No updates available.",
    "updates.status.available": "Update available: {tag}",
    "updates.check_now": "Check now",
    "updates.install": "Download & install",
    "updates.auto": "Auto-install updates on startup",
    "updates.open_release": "Open release page",
    "updates.title": "Updates",
    "updates.download_install": "Download & install",
    "updates.auto_install": "Auto-install updates on startup",
    "updates.searching": "Checking for updates…",
    "updates.downloading": "Preparing update…",
    "updates.opened_browser": "Opened release page in browser.",
    "updates.open_failed": "Could not open browser",
    "updates.not_checked": "(not checked yet)",
    "updates.save_failed": "Could not save config",
    "updates.available": "Update available",
    "updates.none": "No update found",
    "updates.no_download": "No downloadable update found. Click 'Check now' first.",
    "updates.failed": "Update failed",
    },
    "es": {
        # App
        "app.title": "Shelly Energy Analyzer",

        # Generic
        "btn.apply": "Aplicar",
        "btn.reset": "Restablecer",
        "common.from": "de",
        "common.to": "a",
        "common.date_hint": "(YYYY-MM-DD o DD.MM.AAAA)",
        "common.custom": "Personalizado",
        "common.minutes": "minutos",
        "common.hours": "horas",
        "common.days": "días",

        # Top bar / tabs
        "ui.view": "Vista (máx. 2 dispositivos):",
        "tabs.sync": "Sincronizar",
        "tabs.plots": "Gráficos",
        "tabs.live": "En vivo",
        "tabs.export": "Exportar",
        "tabs.settings": "Ajustes",

        "tabs.setup": "Setup",

        # Setup wizard
        "setup.title": "Configuración inicial",
        "setup.subtitle": "Este asistente te ayuda a empezar: descubrir dispositivos Shelly (mDNS/IP) y configurar Telegram opcionalmente.",
        "setup.placeholder": "Completa primero la configuración (añade al menos un dispositivo). Después se activarán estas pestañas.",

        "setup.step.devices": "Dispositivos",
        "setup.step.telegram": "Telegram (opcional)",
        "setup.step.finish": "Finalizar",

        "setup.btn.back": "Atrás",
        "setup.btn.next": "Siguiente",
        "setup.btn.finish": "Finalizar",

        "setup.devices.hint": "1) Descubre dispositivos Shelly por mDNS (recomendado) o escaneando tu subred local /24.\n2) Selecciona los dispositivos encontrados y añádelos.\nPuedes ajustar nombres/keys más tarde en Ajustes → Dispositivos.",
        "setup.devices.status.idle": "Listo.",
        "setup.devices.status.mdns": "Buscando por mDNS …",
        "setup.devices.status.ipscan": "Escaneando red {prefix}.0/24 …",
        "setup.devices.status.found": "{n} encontrados",
        "setup.devices.status.done": "Hecho: {n} encontrados",
        "setup.devices.status.mdns_err": "mDNS no disponible: {err}",

        "setup.devices.btn.mdns": "Descubrir (mDNS)",
        "setup.devices.btn.ipscan": "Escaneo IP (/24)",
        "setup.devices.manual.label": "IP/Host manual:",
        "setup.devices.manual.btn.add": "Añadir",
        "setup.devices.status.manual": "Probando {host} ...",
        "setup.devices.status.not_shelly": "No es Shelly: {host}",

        "setup.devices.btn.add": "Añadir seleccionados",

        "setup.devices.col.host": "IP/Host",
        "setup.devices.col.model": "Modelo",
        "setup.devices.col.kind": "Tipo",
        "setup.devices.col.gen": "Gen",

        "setup.devices.add.ok": "Añadido(s) {n} dispositivo(s)",
        "setup.devices.add.none": "Nada seleccionado",

        "setup.telegram.hint": "Telegram es opcional. También puedes configurarlo más tarde en Ajustes.",
        "setup.telegram.enable": "Activar Telegram",
        "setup.telegram.save": "Guardar",

        "setup.finish.hint": "Configuración completa. Ya puedes usar Sync/Plots/Live.",
        "setup.finish.summary": "Dispositivos: {n}\nConsejo: abre Ajustes → Dispositivos para ajustar nombres/keys.",
        "setup.finish.need_device": "Primero añade al menos un dispositivo (Paso 1).",
        "tabs.billing": "Factura",

        # Sync tab
        "sync.header": "Sincronizar (incremental o rango fijo)",
        "sync.btn.incremental": "Incremental",
        "sync.btn.day": "Día",
        "sync.btn.week": "Semana",
        "sync.btn.month": "Mes",
        "sync.auto_live": "auto (Live)",
        "sync.from": "desde",
        "sync.startdate": "Fecha inicio",
        "sync.reload": "Recargar datos",
        "autosync.active": "Activo",
        "autosync.interval": "Intervalo:",
        "autosync.hours": "h",
        "autosync.mode": "Modo:",

        # Plots tab
        "plots.header": "Estadísticas (kWh) en barras",
        "plots.reload": "Recargar",
        "plots.range": "Rango para gráficos (opcional):",
        "plots.view": "Vista:",
        "plots.view.timeseries": "W/V/A (serie temporal)",
        "plots.view.kwh": "kWh (barras)",
        "plots.kwh.granularity": "Estadística:",
        "plots.kwh.title": "Estadística (kWh)",
        "plots.view.energy": "kWh (barras)",
        "plots.view.wva": "W/V/A (serie temporal)",
        "plots.wva.metric": "Métrica:",
        "plots.wva.window": "Ventana:",
        "plots.no_data": "(sin datos)",
        "plots.no_data_va_hint": "(sin historial V/A – inicia Live)",
        "plots.mode.all": "Todo",
        "plots.mode.days": "Días",
        "plots.mode.weeks": "Semanas",
        "plots.mode.months": "Meses",
        "plots.mode.hours": "Horas",
        "plots.kwh.last": "Últimas:",
        "plots.kwh.last_n": "Últimas {n} {unit}",

        # Plots (web/Plotly)
        "plots.web.header": "Vista Plotly (Safari/Web)",
        "plots.web.open": "Abrir en el navegador",
        "plots.web.embed": "Abrir en la app",
        "plots.web.hint": "Los gráficos interactivos se renderizan como una página web local (Plotly).\n\n- Navegador: abre Safari (o tu navegador predeterminado).\n- En la app: opcional (pywebview) – si está instalado.\n\nConsejo: este modo escala bien en pantalla completa/5K y no requiere Chrome.",
        "plots.web.no_server": "No se pudo iniciar el servidor web.",
        "plots.web.window": "Gráficos",

        "btn.copy": "Copiar",

        # Live tab
        "live.off": "En vivo está apagado.",
        "live.running": "En vivo …",
        "live.start": "Iniciar",
        "live.stop": "Detener",
        "live.freeze": "Freeze",
        "live.export_png": "Snapshot PNG",
        "live.polling_s": "Sondeo (s)",
        "live.window_min": "Ventana (min)",
        "live.web": "Web",
        "live.update_s": "Actualización (s)",
        "live.qr.hint": "Nota: el URL/QR aparecerá en la pestaña En vivo.",
        "live.web_error": "No se pudo iniciar el panel web:",
        "live.cards.power": "Potencia",
        "live.cards.voltage": "Voltaje",
        "live.cards.current": "Corriente",
        "live.cards.kwh_today": "kWh hoy",
        "live.cards.updated": "Actualizado",
        "live.cards.switch": "Interruptor",
        "live.switch.toggle": "Alternar",
        "live.switch.on": "Encendido",
        "live.switch.off": "Apagado",
        "live.chart.power": "Potencia (W)",
        "live.chart.voltage": "Voltaje (V) – L1/L2/L3",
        "live.chart.voltage.1p": "Voltaje (V) – L1",
        "live.chart.current": "Corriente (A) – L1/L2/L3",
        "live.chart.current.1p": "Corriente (A) – L1",
        "live.time": "Tiempo",

        # Export tab
        "export.dir": "Carpeta de exportación:",
        "export.range": "Rango (opcional, YYYY-MM-DD):",
        "export.invoice_period": "Periodo de factura:",
        "export.anchor": "Fecha ancla (opcional):",
        "export.btn.excel": "Exportar Excel",
        "export.btn.pdf_summary": "Exportar PDF resumen + gráficos",
        "export.btn.invoices": "Facturas (PDF) por Shelly",
        "export.btn.plots": "Exportar gráficos (días/semanas/meses)",
        "export.btn.day_report_v1": "Informe diario PDF (v1)",
        "export.btn.month_report_v1": "Informe mensual PDF (v1)",
        "export.btn.current_png": "Vista actual → PNG",
        "export.btn.current_pdf": "Vista actual → PDF",

        # Period labels
        "period.custom": "Personalizado",
        "period.day": "Día",
        "period.week": "Semana",
        "period.month": "Mes",
        "period.year": "Año",

        # Settings
        "settings.save": "Guardar",
        "settings.reload": "Recargar config",
        "settings.saved": "Guardado: {path}",
        "settings.devices": "Dispositivos",
        "settings.main": "En vivo & Precio",
        "settings.advanced": "Avanzado",
        "settings.expert": "Experto",
        "settings.expert.note": "Todas las opciones de config.json son editables aquí. Potente: usa Validar/Copia.",
        "settings.download.title": "Descarga / Red",
        "settings.download.chunk_h": "Bloque (h):",
        "settings.download.overlap_s": "Solape (s):",
        "settings.download.timeout_s": "Timeout (s):",
        "settings.download.retries": "Reintentos:",
        "settings.download.backoff": "Backoff:",
        "settings.download.note": "Nota: Los cambios se aplican en la próxima sincronización.",
        "settings.csv_pack.title": "CSV Pack / Archivos",
        "settings.csv_pack.threshold": "Umbral (# archivos):",
        "settings.csv_pack.max_mb": "Máx (MB):",
        "settings.csv_pack.remove_merged": "Eliminar archivos combinados después de empaquetar",
        "settings.ui_advanced.title": "UI / Avanzado",
        "settings.ui_advanced.retention_min": "Retención (min, >=120):",
        "settings.ui_advanced.web_token": "Token web:",
        "settings.ui_advanced.start_page": "Página inicial (vista):",
        "settings.ui_advanced.smoothing_enable": "Activar suavizado en vivo",
        "settings.ui_advanced.smoothing_seconds": "Suavizado (s):",
        "settings.ui_advanced.note": "Nota: La retención debe ser al menos 120 minutos. El token protege acciones web (opcional).",
        "settings.raw.title": "Config (JSON)",
        "settings.raw.reload": "Recargar desde disco",
        "settings.raw.pretty": "Formatear",
        "settings.raw.validate": "Validar",
        "settings.raw.apply": "Aplicar",
        "settings.raw.parse_error": "Error JSON",
        "settings.raw.empty": "El editor está vacío.",
        "settings.raw.valid_ok": "La configuración es válida.",
        "settings.raw.invalid": "Configuración inválida",
        "settings.raw.write_error": "No se pudo escribir config.json",
        "settings.raw.reload_error": "No se pudo cargar config.json",
        "settings.raw.pretty_ok": "JSON formateado.",
        "settings.raw.applied": "Config aplicada: {path}",
        "settings.devices.hint": "(La app/web muestra 2 dispositivos a la vez. Cambia arriba en “Vista”.)",
        "settings.devices.key": "Key",
        "settings.devices.name": "Nombre",
        "settings.devices.host": "Host/IP",
        "settings.devices.emid": "EM ID",
        "settings.devices.model": "Modelo",
        "settings.devices.kind": "Tipo",
        "settings.device.add": "Agregar",
        "settings.device.add_auto": "Agregar por IP (Auto)",
        "settings.device.add_by_ip.title": "Agregar dispositivo por IP",
        "settings.device.add_by_ip.ip": "IP/Host:",
        "settings.device.add_by_ip.name_optional": "Nombre (opcional):",
        "settings.device.add_by_ip.probing": "Detectando dispositivo...",
        "settings.device.add_by_ip.failed": "Detección fallida",
        "settings.device.add_by_ip.add": "Agregar",
        "settings.cancel": "Cancelar",
        "settings.device.check_all": "Comprobar todos",
        "settings.device.check_all.running": "Comprobando dispositivos...",
        "settings.device.check_all.done": "Comprobación finalizada (guarda los cambios)",

        "settings.mdns.title": "Shellys encontrados (mDNS)",
        "settings.mdns.hint": "Pulsa “Iniciar búsqueda” para encontrar Shellys en tu red automáticamente.",
        "settings.mdns.scan": "Iniciar búsqueda",
        "settings.mdns.scanning": "Buscando Shellys por mDNS…",
        "settings.mdns.failed": "La búsqueda mDNS falló",
        "settings.mdns.none": "No se encontraron Shellys.",
        "settings.mdns.found_n": "Se encontraron {n} Shellys.",
        "settings.mdns.add_selected": "Añadir dispositivo seleccionado",
        "settings.mdns.col_name": "Nombre",
        "settings.mdns.col_host": "IP",
        "settings.mdns.col_model": "Modelo",
        "settings.mdns.col_gen": "Gen",
        "settings.mdns.col_service": "Servicio",

        "settings.health.title": "Salud del dispositivo / diagnóstico de red",
        "settings.health.hint": "Pulsa “Health check” para medir latencia TCP/HTTP, firmware y estado live.",
        "settings.health.run": "Health check",
        "settings.health.running": "Ejecutando health check…",
        "settings.health.done": "Health check listo ({n} dispositivos).",
        "settings.health.copy": "Copiar",
        "settings.health.copied": "Copiado al portapapeles.",
        "settings.health.nothing": "Aún no hay resultados – ejecuta el health check primero.",
        "settings.health.col_device": "Dispositivo",
        "settings.health.col_host": "IP",
        "settings.health.col_tcp": "TCP ms",
        "settings.health.col_http": "HTTP ms",
        "settings.health.col_model": "Modelo",
        "settings.health.col_fw": "Firmware",
        "settings.health.col_last_ok": "Último OK",
        "settings.health.col_err_count": "Errores",
        "settings.health.col_last_err": "Último error",

        "settings.alerts.title": "Alarmas",
        "settings.alerts.hint": "Reglas locales simples: si una métrica se mantiene por encima/debajo del umbral durante cierto tiempo, muestra popup/beep.",
        "settings.alerts.add": "Añadir regla",
        "settings.alerts.remove": "Quitar última regla",
        "settings.alerts.col_id": "ID",
        "settings.alerts.col_enabled": "On",
        "settings.alerts.col_device": "Dispositivo",
        "settings.alerts.col_metric": "Métrica",
        "settings.alerts.col_op": "Op",
        "settings.alerts.col_threshold": "Umbral",
        "settings.alerts.col_duration": "Duración s",
        "settings.alerts.col_cooldown": "Cooldown s",
        "settings.alerts.col_popup": "Popup",
        "settings.alerts.col_beep": "Beep",
        "settings.alerts.col_telegram": "Telegram",
        "settings.alerts.device_all": "Todos los dispositivos",
        "settings.alerts.telegram.enabled": "Activar Telegram",
        "settings.alerts.telegram.token": "Token del bot",
        "settings.alerts.telegram.chat_id": "ID de chat",
        "settings.alerts.telegram.verify_ssl": "Verificar certificado SSL",
        "settings.alerts.telegram.alarm_plots": "Incluir gráficos de alarma (últimos 10 min)",
        "settings.alerts.telegram.test": "Enviar prueba",
        "settings.alerts.telegram.daily_summary": "Resumen diario (día anterior)",
        "settings.alerts.telegram.daily_time": "Hora",
        "settings.alerts.telegram.daily_send_now": "Enviar ahora",
        "settings.alerts.telegram.monthly_summary": "Resumen mensual (mes anterior)",
        "settings.alerts.telegram.summary_load_w": "Carga mínima para VAR/cosφ (W)",
        "settings.alerts.telegram.monthly_time": "Hora",
        "settings.alerts.telegram.monthly_send_now": "Enviar ahora",
        "settings.alerts.col_message": "Mensaje",
        "settings.alerts.fired": "{device}: {metric} {value:.2f} {op} {threshold:.2f}",
        "settings.alerts.confirm_delete_active": "La regla \"{rule}\" está activa. ¿Eliminar de todos modos?",

        "settings.device.remove": "Quitar dispositivo",
        "settings.device.remove.select": "Elegir dispositivo",
        "settings.device.remove.need_one": "Debe quedar al menos un dispositivo.",
        "settings.device.removed.title": "Dispositivos eliminados",
        "settings.device.removed.archived": "Los datos se movieron a 'data/deleted':",
        "settings.device.removed.ask_archive": "¿Archivar los datos también?\n\nSí = mover a 'data/deleted'\nNo = mantener los datos",
        "settings.language": "Idioma",
        "settings.language.de": "Alemán",
        "settings.language.en": "Inglés",
        "settings.language.es": "Español",
        "settings.language.fr": "Francés",
        "settings.language.pt": "Portugués",
        "settings.language.it": "Italiano",
        "settings.language.pl": "Polaco",
        "settings.language.cs": "Checo",
        "settings.language.ru": "Ruso",

        # Settings: Pricing
        "settings.pricing.title": "Precio & IVA",
        "settings.pricing.price": "Precio (€/kWh):",
        "settings.pricing.price_includes_vat": "Precio incluye IVA (bruto)",
        "settings.pricing.vat_enabled": "IVA activo",
        "settings.pricing.vat_rate": "Tasa IVA (%):",
        "settings.pricing.base_fee": "Cuota base (€/año):",
        "settings.pricing.base_fee_includes_vat": "Cuota base incluye IVA (bruto)",

        # Settings: Autosync
        "settings.autosync.title": "Autosync",
        "settings.autosync.enabled": "Autosync activo",
        "settings.autosync.interval_h": "Intervalo (h):",
        "settings.autosync.mode": "Modo:",

        # Settings: Live
        "settings.live.title": "Vista en vivo",
        "settings.live.polling": "Sondeo (s):",
        "settings.live.window": "Ventana (min):",
        "settings.live.redraw": "Redibujar (s):",
        "settings.live.note": "Nota: los cambios se aplican como máximo al reiniciar En vivo.",

        # Settings: Web
        "settings.web.title": "Panel web en vivo",
        "settings.web.enable": "Activar",
        "settings.web.port": "Puerto:",
        "settings.web.update": "Actualización (s):",
        "settings.web.note": "Nota: el URL/QR aparecerá en la pestaña En vivo.",

        # Billing
        "billing.title": "Datos de factura",
        "billing.issuer.title": "Emisor / Empresa",
        "billing.customer.title": "Cliente",
        "billing.invoice_settings.title": "Ajustes de factura",
        "billing.field.name": "Nombre:",
        "billing.field.address": "Dirección:",
        "billing.field.vat_id": "ID IVA:",
        "billing.field.vat_id_optional": "ID IVA (opcional):",
        "billing.field.email": "Correo:",
        "billing.field.phone": "Teléfono:",
        "billing.field.iban": "IBAN:",
        "billing.field.bic": "BIC:",
        "billing.field.prefix": "Prefijo:",
        "billing.field.payment_terms": "Plazo de pago (días):",

        # Message titles
        "msg.settings": "Ajustes",
        "msg.devices": "Dispositivos",
        "msg.sync": "Sincronizar",
        "msg.export": "Exportar",
        "msg.data_load": "Cargar datos",
        "msg.live_web": "Panel web en vivo",

        # Message texts
        "sync.err.need_date": "Introduce una fecha de inicio (DD.MM.AAAA).",
        "sync.err.bad_date": "Fecha inválida: {s}. Formato: DD.MM.AAAA (p. ej. 01.10.2025)",
        "sync.info.running": "La sincronización ya está en marcha.",
        "sync.info.skipped_no_csv": "Omitido (sin soporte CSV; el modo en vivo sigue funcionando).",
        "export.no_data": "No hay datos cargados.",
        "settings.need_device": "Debe configurarse al menos un dispositivo.",
        "settings.reload.done": "Config recargada.",
        "settings.reload.note": "Reinicia la app si En vivo está activo.",

        # Misc / status messages
        "autosync.next_run": "Próxima ejecución: {nxt} ({interval_h}h)",
        "autosync.off": "Autosync: apagado",
        "sync.err.generic": "ERROR Sync: {e}",
        "log.open_error": "No se pudo abrir el log:\n{e}",
        "live.smoothing": "Suavizar",
        "live.daynight": "Día/Noche",
        "live.all": "Auto",
        "live.day": "Día",
        "live.night": "Noche",
        "live.open_log": "Abrir log",
        "live.settings_saved": "Ajustes de En vivo guardados.",
        "live.status.running_web": "En vivo… Web: {url}",
        "live.status.web_error": "En vivo… (error web: {e})",
        "export.current_view_info": "La exportación de vista actual funciona para En vivo y Gráficos.",
        "export.current_view_exported": "Vista actual exportada: {path}",
        "export.err.live_failed": "La exportación de En vivo falló: {e}",
        "export.err.plots_failed": "La exportación de gráficos falló: {e}",
        "export.err.active_plot_tab": "No se pudo determinar la pestaña activa del gráfico",
        "export.err.plots_notebook": "No está disponible el cuaderno de gráficos",
        "export.err.active_device": "No se pudo determinar el dispositivo activo en el gráfico",
        "export.err.figure_unavailable": "Figura del gráfico no disponible (redibuja una vez)",

        # Web: Live dashboard
        "web.live.title": "Shelly Live Dashboard",
        "web.live.meta_refresh": "Actualización: cada",
        "web.nav.live": "En vivo",
        "web.nav.control": "Control",
        "web.pill.window": "Ventana",
        "web.pill.url": "URL",
        "web.chart.power": "Potencia (W)",
        "web.chart.voltage": "Voltaje (V) – L1/L2/L3",
        "web.chart.voltage.1p": "Voltaje (V) – L1",
        "web.chart.current": "Corriente (A) – L1/L2/L3",
        "web.chart.current.1p": "Corriente (A) – L1",
        "web.kv.power": "Potencia",
        "web.kv.kwh_today": "kWh hoy",
        "web.kv.u": "U",
        "web.kv.i": "I",
        "web.kv.var": "Potencia reactiva",
        "web.kv.cosphi": "cos φ",
        "web.switch": "Interruptor",
        "web.switch.toggle": "Cambiar",
        "web.switch.on": "Encendido",
        "web.switch.off": "Apagado",
        "web.theme.dark": "Modo oscuro",
        "web.theme.light": "Modo claro",
        "web.btn.theme": "Tema",
        "web.btn.refresh": "Actualizar",
        "web.btn.autorefresh": "Auto",
        "web.autorefresh.on": "Auto-actualizar: sí",
        "web.autorefresh.off": "Auto-actualizar: no",
        "web.freeze": "Congelar",
        "web.freeze.on": "Congelar: sí",
        "web.freeze.off": "Congelar: no",

        # Web: Control page
        "web.control.title": "Control Shelly",
        "web.control.meta": "Desde aquí puedes iniciar sync/gráficos/exportaciones.",
        "web.control.sync": "Sync",
        "web.control.plots": "Gráficos",
        "web.control.open_plotly": "Abrir gráficos interactivos",

        # Web: Plotly plots page
        "web.plots.title": "Gráficos",
        "web.loading": "Cargando…",
        "web.error": "Error",
        "web.unknown": "desconocido",
        "web.axis.time": "Tiempo",
        "web.plots.view": "Vista",
        "web.plots.metric": "Métrica",
        "web.plots.kwh_mode": "Modo",
        "web.plots.range": "Rango",
        "web.plots.devices": "Dispositivos (máx. 2)",
        "web.plots.max2": "máx. 2 dispositivos",
        "web.plots.no_devices": "No hay dispositivos configurados",
        "web.plots.no_data": "No se encontraron datos",
        "web.plots.series": "Serie",
        "web.plots.series.total": "Total",
        "web.plots.series.phases": "Fases (L1/L2/L3)",
        "web.plots.filter.smooth": "Suavizado (s)",
        "web.plots.filter.deadband": "Banda muerta (VAR)",
        "web.plots.filter.signhold": "Retención de signo (s)",
        "web.control.export": "Exportar",
        "web.control.jobs": "Tareas",
        "web.control.mode": "Modo",
        "web.control.start": "Inicio (DD.MM.AAAA)",
        "web.control.btn.sync": "Iniciar sync",
        "web.control.plots.from": "de",
        "web.control.plots.to": "a",
        "web.control.btn.plots": "Generar gráficos",
        "web.control.invoice": "Factura",
        "web.control.anchor": "Ancla",
        "web.control.custom_note": "(en custom se usa de/a)",
        "web.control.btn.pdf": "PDF resumen + gráficos",
        "web.control.btn.invoices": "Facturas por Shelly",
        "web.control.btn.bundle": "ZIP paquete (48h)",
        "web.control.btn.report_day": "Informe (día)",
        "web.control.btn.report_month": "Informe (mes)",
        "web.control.jobs.meta": "Últimas acciones (navegador ↔ app). Actualiza automático.",

        # Web: Token / errors
        "web.token.denied_title": "Acceso denegado",
        "web.token.protected": "Esta página está protegida por un token. Abre la URL desde la app de escritorio (incl. ?t=...) o pega el token aquí.",
        "web.token.placeholder": "Token (p. ej. a1b2c3d4)",
        "web.token.open": "Abrir",
        "web.token.tip": "Consejo: La app muestra la URL completa y la ofrece como código QR.",
        "web.err.start_command": "Ejecuta start.command.",
        "web.err.plotly_timeout": "No se pudo cargar Plotly. Ejecuta start.command (instala plotly) o comprueba /static/plotly.min.js.",
        "first_run.hint": "¡Bienvenido! Primero añade/verifica tus dispositivos Shelly y pulsa Guardar. Mientras no haya dispositivos configurados, la app no cargará CSVs y no mostrará avisos emergentes.",
        "first_run.status": "Primer inicio: configura los dispositivos en Ajustes → Dispositivos y pulsa Guardar.",
  "demo.device.house_3p": "Casa Demo (3 fases)",
  "demo.device.garage_1p": "Garaje Demo (1 fase)",
  "demo.mode.active": "MODO DEMO activo — no se usan dispositivos reales",
    "settings.updates": "Actualizaciones",
    "updates.status.idle": "Listo.",
    "updates.status.checking": "Buscando actualizaciones…",
    "updates.status.unreachable": "GitHub no accesible (sin conexión/tiempo de espera).",
    "updates.status.none": "No hay actualizaciones.",
    "updates.status.available": "Actualización disponible: {tag}",
    "updates.check_now": "Comprobar ahora",
    "updates.install": "Descargar e instalar",
    "updates.auto": "Instalar actualizaciones automáticamente al iniciar",
    "updates.open_release": "Abrir página del release",
    "updates.title": "Actualizaciones",
    "updates.download_install": "Descargar e instalar",
    "updates.auto_install": "Instalar automáticamente al iniciar",
    "updates.searching": "Buscando actualizaciones…",
    "updates.downloading": "Preparando la actualización…",
    "updates.opened_browser": "Página de release abierta en el navegador.",
    "updates.open_failed": "No se pudo abrir el navegador",
    "updates.not_checked": "(aún no comprobado)",
    "updates.save_failed": "No se pudo guardar la configuración",
    "updates.available": "Actualización disponible",
    "updates.none": "No hay actualización",
    "updates.no_download": "No hay descarga disponible. Primero pulsa “Comprobar ahora”.",
    "updates.failed": "Falló la actualización",
    },
}


# ---------------------------------------------------------------------------
# Extra languages
#
# To keep this file maintainable, we derive additional languages from English
# and override the most visible UI strings. Any missing key will fall back to
# German via `t()`.
# ---------------------------------------------------------------------------

_BASE_EN = dict(_I18N.get("en", {}) or {})


def _mk_lang(overrides: Dict[str, str]) -> Dict[str, str]:
    d = dict(_BASE_EN)
    d.update(overrides or {})
    return d


_I18N["fr"] = _mk_lang({
    "web.loading": "Chargement…",
    "web.error": "Erreur",
    "web.unknown": "inconnu",
    "web.axis.time": "Temps",
    "web.plots.view": "Vue",
    "web.plots.metric": "Mesure",
    "web.plots.kwh_mode": "Statistique",
    "web.plots.range": "Période",
    "web.plots.devices": "Appareils (max. 2)",
    "web.plots.max2": "max. 2 appareils",
    "web.plots.no_devices": "Aucun appareil configuré",
    "web.plots.no_data": "Aucune donnée",
    "web.plots.series": "Série",
    "web.plots.series.total": "Total",
    "web.plots.series.phases": "Phases (L1/L2/L3)",
    "btn.apply": "Appliquer",
    "btn.reset": "Réinitialiser",
    "btn.copy": "Copier",
    "common.from": "de",
    "common.to": "à",
    "common.custom": "Personnalisé",
    "common.minutes": "minutes",
    "common.hours": "heures",
    "common.days": "jours",
    "tabs.sync": "Sync",
    "tabs.plots": "Graphiques",
    "tabs.live": "En direct",
    "tabs.export": "Export",
    "tabs.settings": "Paramètres",
    "tabs.billing": "Facture",
    "sync.btn.day": "Jour",
    "sync.btn.week": "Semaine",
    "sync.btn.month": "Mois",
    "sync.startdate": "Date de début",
    "sync.reload": "Recharger les données",
    "plots.reload": "Recharger",
    "plots.view": "Vue :",
    "plots.mode.days": "Jours",
    "plots.mode.weeks": "Semaines",
    "plots.mode.months": "Mois",
    "plots.mode.hours": "Heures",
    "live.off": "En direct est arrêté.",
    "live.running": "En direct…",
    "live.start": "Démarrer",
    "live.stop": "Stop",
    "live.freeze": "Freeze",
    "live.export_png": "Instantané PNG",
    "live.polling_s": "Polling (s)",
    "live.window_min": "Fenêtre (min)",
    "live.update_s": "Mise à jour (s)",
    "live.cards.power": "Puissance",
    "live.cards.voltage": "Tension",
    "live.cards.current": "Courant",
    "live.cards.kwh_today": "kWh aujourd'hui",
    "live.cards.updated": "Mis à jour",
    "live.cards.switch": "Interrupteur",
    "live.switch.toggle": "Basculer",
    "live.switch.on": "On",
    "live.switch.off": "Off",
    "export.dir": "Dossier d'export :",
    "export.range": "Période (optionnel, YYYY-MM-DD) :",
    "export.invoice_period": "Période de facture :",
    "export.anchor": "Date d'ancrage (optionnel) :",
    "export.btn.excel": "Exporter Excel",
    "export.btn.pdf_summary": "Exporter PDF résumé + graphiques",
    "export.btn.invoices": "Factures (PDF) par Shelly",
    "export.btn.plots": "Exporter les graphiques (jours/semaines/mois)",
    "export.btn.day_report_v1": "Rapport journalier PDF (v1)",
    "export.btn.month_report_v1": "Rapport mensuel PDF (v1)",
    "export.btn.current_png": "Vue actuelle → PNG",
    "export.btn.current_pdf": "Vue actuelle → PDF",
    "period.custom": "Personnalisé",
    "period.day": "Jour",
    "period.week": "Semaine",
    "period.month": "Mois",
    "period.year": "Année",
    "settings.save": "Enregistrer",
    "settings.reload": "Recharger la config",
    "settings.devices": "Appareils",
    "settings.main": "En direct & Prix",
    "settings.advanced": "Avancé",
    "settings.expert": "Expert",
    "settings.language": "Langue",
    "settings.language.de": "Allemand",
    "settings.language.en": "Anglais",
    "settings.language.es": "Espagnol",
    "settings.language.fr": "Français",
    "settings.language.pt": "Portugais",
    "settings.language.it": "Italien",
    "settings.language.pl": "Polonais",
    "settings.language.cs": "Tchèque",
    "settings.language.ru": "Russe",
    "settings.pricing.title": "Prix & TVA",
    "settings.pricing.vat_enabled": "TVA activée",
    "settings.web.title": "Dashboard Web (Live)",
    "billing.title": "Données de facture",
    "msg.settings": "Paramètres",
    "msg.data_load": "Charger les données",
    "web.nav.control": "Contrôle",
    "web.control.title": "Contrôle Shelly",
    "web.control.export": "Export",
    "web.control.jobs": "Tâches",
    "web.freeze.on": "Freeze : activé",
    "web.freeze.off": "Freeze : désactivé",
})


_I18N["pt"] = _mk_lang({
    "web.loading": "Carregando…",
    "web.error": "Erro",
    "web.unknown": "desconhecido",
    "web.axis.time": "Tempo",
    "web.plots.view": "Vista",
    "web.plots.metric": "Métrica",
    "web.plots.kwh_mode": "Estatística",
    "web.plots.range": "Intervalo",
    "web.plots.devices": "Dispositivos (máx. 2)",
    "web.plots.max2": "máx. 2 dispositivos",
        "web.plots.no_devices": "No hay dispositivos configurados",
    "web.plots.no_data": "Sem dados",
    "web.plots.series": "Série",
    "web.plots.series.total": "Total",
    "web.plots.series.phases": "Fases (L1/L2/L3)",
    "btn.apply": "Aplicar",
    "btn.reset": "Repor",
    "btn.copy": "Copiar",
    "common.from": "de",
    "common.to": "até",
    "common.custom": "Personalizado",
    "common.minutes": "minutos",
    "common.hours": "horas",
    "common.days": "dias",
    "tabs.plots": "Gráficos",
    "tabs.live": "Ao vivo",
    "tabs.export": "Exportar",
    "tabs.settings": "Definições",
    "tabs.billing": "Fatura",
    "sync.btn.day": "Dia",
    "sync.btn.week": "Semana",
    "sync.btn.month": "Mês",
    "sync.startdate": "Data de início",
    "sync.reload": "Recarregar dados",
    "plots.reload": "Recarregar",
    "live.off": "Ao vivo está desligado.",
    "live.running": "Ao vivo…",
    "live.start": "Iniciar",
    "live.stop": "Parar",
    "live.export_png": "Snapshot PNG",
    "export.dir": "Pasta de exportação:",
    "export.btn.excel": "Exportar Excel",
    "export.range": "Período (opcional, YYYY-MM-DD):",
    "export.invoice_period": "Período de faturação:",
    "export.anchor": "Data âncora (opcional):",
    "export.btn.pdf_summary": "Exportar resumo PDF + gráficos",
    "export.btn.invoices": "Faturas (PDF) por Shelly",
    "export.btn.plots": "Exportar gráficos (dias/semanas/meses)",
    "export.btn.day_report_v1": "Relatório diário PDF (v1)",
    "export.btn.month_report_v1": "Relatório mensal PDF (v1)",
    "export.btn.current_png": "Vista atual → PNG",
    "export.btn.current_pdf": "Vista atual → PDF",
    "period.custom": "Personalizado",
    "period.day": "Dia",
    "period.week": "Semana",
    "period.month": "Mês",
    "period.year": "Ano",
    "settings.save": "Guardar",
    "settings.reload": "Recarregar config",
    "settings.language": "Idioma",
    "settings.language.de": "Alemão",
    "settings.language.en": "Inglês",
    "settings.language.es": "Espanhol",
    "settings.language.fr": "Francês",
    "settings.language.pt": "Português",
    "settings.language.it": "Italiano",
    "settings.language.pl": "Polaco",
    "settings.language.cs": "Tcheco",
    "settings.language.ru": "Russo",
    "tabs.settings": "Definições",
    "msg.settings": "Definições",
    "web.control.title": "Controlo Shelly",
})


_I18N["it"] = _mk_lang({
    "web.loading": "Caricamento…",
    "web.error": "Errore",
    "web.unknown": "sconosciuto",
    "web.axis.time": "Tempo",
    "web.plots.view": "Vista",
    "web.plots.metric": "Metrica",
    "web.plots.kwh_mode": "Statistica",
    "web.plots.range": "Intervallo",
    "web.plots.devices": "Dispositivi (max. 2)",
    "web.plots.max2": "max. 2 dispositivi",
    "web.plots.no_devices": "Nessun dispositivo configurato",
    "web.plots.no_data": "Nessun dato",
    "web.plots.series": "Serie",
    "web.plots.series.total": "Totale",
    "web.plots.series.phases": "Fasi (L1/L2/L3)",
    "btn.apply": "Applica",
    "btn.reset": "Reimposta",
    "btn.copy": "Copia",
    "common.from": "da",
    "common.to": "a",
    "common.custom": "Personalizzato",
    "common.minutes": "minuti",
    "common.hours": "ore",
    "common.days": "giorni",
    "tabs.plots": "Grafici",
    "tabs.live": "Live",
    "tabs.export": "Esporta",
    "tabs.settings": "Impostazioni",
    "tabs.billing": "Fattura",
    "sync.btn.day": "Giorno",
    "sync.btn.week": "Settimana",
    "sync.btn.month": "Mese",
    "sync.startdate": "Data inizio",
    "sync.reload": "Ricarica dati",
    "plots.reload": "Ricarica",
    "live.off": "Live è spento.",
    "live.running": "Live…",
    "live.start": "Avvia",
    "live.stop": "Stop",
    "export.dir": "Cartella export:",
    "export.btn.excel": "Esporta Excel",
    "export.range": "Periodo (opzionale, YYYY-MM-DD):",
    "export.invoice_period": "Periodo fattura:",
    "export.anchor": "Data ancoraggio (opzionale):",
    "export.btn.pdf_summary": "Esporta riepilogo PDF + grafici",
    "export.btn.invoices": "Fatture (PDF) per Shelly",
    "export.btn.plots": "Esporta grafici (giorni/settimane/mesi)",
    "export.btn.day_report_v1": "Report giornaliero PDF (v1)",
    "export.btn.month_report_v1": "Report mensile PDF (v1)",
    "export.btn.current_png": "Vista attuale → PNG",
    "export.btn.current_pdf": "Vista attuale → PDF",
    "period.custom": "Personalizzato",
    "period.day": "Giorno",
    "period.week": "Settimana",
    "period.month": "Mese",
    "period.year": "Anno",
    "settings.save": "Salva",
    "settings.reload": "Ricarica config",
    "settings.language": "Lingua",
    "settings.language.de": "Tedesco",
    "settings.language.en": "Inglese",
    "settings.language.es": "Spagnolo",
    "settings.language.fr": "Francese",
    "settings.language.pt": "Portoghese",
    "settings.language.it": "Italiano",
    "settings.language.pl": "Polacco",
    "settings.language.cs": "Ceco",
    "settings.language.ru": "Russo",
    "msg.settings": "Impostazioni",
    "web.control.title": "Controllo Shelly",
})


_I18N["pl"] = _mk_lang({
    "web.loading": "Ładowanie…",
    "web.error": "Błąd",
    "web.unknown": "nieznane",
    "web.axis.time": "Czas",
    "web.plots.view": "Widok",
    "web.plots.metric": "Metryka",
    "web.plots.kwh_mode": "Statystyka",
    "web.plots.range": "Zakres",
    "web.plots.devices": "Urządzenia (maks. 2)",
    "web.plots.max2": "maks. 2 urządzenia",
    "web.plots.no_devices": "Brak skonfigurowanych urządzeń",
    "web.plots.no_data": "Brak danych",
    "web.plots.series": "Seria",
    "web.plots.series.total": "Suma",
    "web.plots.series.phases": "Fazy (L1/L2/L3)",
    "btn.apply": "Zastosuj",
    "btn.reset": "Resetuj",
    "btn.copy": "Kopiuj",
    "common.from": "od",
    "common.to": "do",
    "common.custom": "Niestandardowy",
    "common.minutes": "minuty",
    "common.hours": "godziny",
    "common.days": "dni",
    "tabs.plots": "Wykresy",
    "tabs.live": "Na żywo",
    "tabs.export": "Eksport",
    "tabs.settings": "Ustawienia",
    "tabs.billing": "Faktura",
    "sync.btn.day": "Dzień",
    "sync.btn.week": "Tydzień",
    "sync.btn.month": "Miesiąc",
    "sync.startdate": "Data startu",
    "sync.reload": "Wczytaj dane ponownie",
    "plots.reload": "Odśwież",
    "live.off": "Na żywo jest wyłączone.",
    "live.start": "Start",
    "live.stop": "Stop",
    "export.dir": "Folder eksportu:",
    "export.btn.excel": "Eksportuj Excel",
    "export.range": "Zakres (opcjonalnie, YYYY-MM-DD):",
    "export.invoice_period": "Okres faktury:",
    "export.anchor": "Data odniesienia (opcjonalnie):",
    "export.btn.pdf_summary": "Eksportuj podsumowanie PDF + wykresy",
    "export.btn.invoices": "Faktury (PDF) na Shelly",
    "export.btn.plots": "Eksportuj wykresy (dni/tygodnie/miesiące)",
    "export.btn.day_report_v1": "Raport dzienny PDF (v1)",
    "export.btn.month_report_v1": "Raport miesięczny PDF (v1)",
    "export.btn.current_png": "Bieżący widok → PNG",
    "export.btn.current_pdf": "Bieżący widok → PDF",
    "period.custom": "Niestandardowy",
    "period.day": "Dzień",
    "period.week": "Tydzień",
    "period.month": "Miesiąc",
    "period.year": "Rok",
    "settings.save": "Zapisz",
    "settings.reload": "Przeładuj config",
    "settings.language": "Język",
    "settings.language.de": "Niemiecki",
    "settings.language.en": "Angielski",
    "settings.language.es": "Hiszpański",
    "settings.language.fr": "Francuski",
    "settings.language.pt": "Portugalski",
    "settings.language.it": "Włoski",
    "settings.language.pl": "Polski",
    "settings.language.cs": "Czeski",
    "settings.language.ru": "Rosyjski",
    "msg.settings": "Ustawienia",
    "web.control.title": "Sterowanie Shelly",
})


_I18N["cs"] = _mk_lang({
    "web.loading": "Načítání…",
    "web.error": "Chyba",
    "web.unknown": "neznámé",
    "web.axis.time": "Čas",
    "web.plots.view": "Zobrazení",
    "web.plots.metric": "Metrika",
    "web.plots.kwh_mode": "Statistika",
    "web.plots.range": "Rozsah",
    "web.plots.devices": "Zařízení (max. 2)",
    "web.plots.max2": "max. 2 zařízení",
    "web.plots.no_devices": "Nejsou nakonfigurována žádná zařízení",
    "web.plots.no_data": "Žádná data",
    "web.plots.series": "Řada",
    "web.plots.series.total": "Celkem",
    "web.plots.series.phases": "Fáze (L1/L2/L3)",
    "btn.apply": "Použít",
    "btn.reset": "Obnovit",
    "btn.copy": "Kopírovat",
    "common.from": "od",
    "common.to": "do",
    "common.custom": "Vlastní",
    "common.minutes": "minuty",
    "common.hours": "hodiny",
    "common.days": "dny",
    "tabs.plots": "Grafy",
    "tabs.live": "Live",
    "tabs.export": "Export",
    "tabs.settings": "Nastavení",
    "tabs.billing": "Faktura",
    "sync.btn.day": "Den",
    "sync.btn.week": "Týden",
    "sync.btn.month": "Měsíc",
    "sync.startdate": "Počáteční datum",
    "sync.reload": "Znovu načíst data",
    "plots.reload": "Znovu načíst",
    "live.off": "Live je vypnuto.",
    "live.start": "Spustit",
    "live.stop": "Stop",
    "export.dir": "Složka exportu:",
    "export.btn.excel": "Exportovat Excel",
    "export.range": "Rozsah (volitelně, YYYY-MM-DD):",
    "export.invoice_period": "Fakturační období:",
    "export.anchor": "Referenční datum (volitelně):",
    "export.btn.pdf_summary": "Exportovat PDF souhrn + grafy",
    "export.btn.invoices": "Faktury (PDF) pro Shelly",
    "export.btn.plots": "Exportovat grafy (dny/týdny/měsíce)",
    "export.btn.day_report_v1": "Denní report PDF (v1)",
    "export.btn.month_report_v1": "Měsíční report PDF (v1)",
    "export.btn.current_png": "Aktuální zobrazení → PNG",
    "export.btn.current_pdf": "Aktuální zobrazení → PDF",
    "period.custom": "Vlastní",
    "period.day": "Den",
    "period.week": "Týden",
    "period.month": "Měsíc",
    "period.year": "Rok",
    "settings.save": "Uložit",
    "settings.reload": "Znovu načíst config",
    "settings.language": "Jazyk",
    "settings.language.de": "Němčina",
    "settings.language.en": "Angličtina",
    "settings.language.es": "Španělština",
    "settings.language.fr": "Francouzština",
    "settings.language.pt": "Portugalština",
    "settings.language.it": "Italština",
    "settings.language.pl": "Polština",
    "settings.language.cs": "Čeština",
    "settings.language.ru": "Ruština",
    "msg.settings": "Nastavení",
    "web.control.title": "Ovládání Shelly",
})


_I18N["ru"] = _mk_lang({
    "web.loading": "Загрузка…",
    "web.error": "Ошибка",
    "web.unknown": "неизвестно",
    "web.axis.time": "Время",
    "web.plots.view": "Вид",
    "web.plots.metric": "Показатель",
    "web.plots.kwh_mode": "Статистика",
    "web.plots.range": "Период",
    "web.plots.devices": "Устройства (макс. 2)",
    "web.plots.max2": "макс. 2 устройства",
    "web.plots.no_devices": "Устройства не настроены",
    "web.plots.no_data": "Нет данных",
    "web.plots.series": "Серия",
    "web.plots.series.total": "Итого",
    "web.plots.series.phases": "Фазы (L1/L2/L3)",
    "btn.apply": "Применить",
    "btn.reset": "Сброс",
    "btn.copy": "Копировать",
    "common.from": "с",
    "common.to": "по",
    "common.custom": "Пользовательский",
    "common.minutes": "минуты",
    "common.hours": "часы",
    "common.days": "дни",
    "tabs.plots": "Графики",
    "tabs.live": "Онлайн",
    "tabs.export": "Экспорт",
    "tabs.settings": "Настройки",
    "tabs.billing": "Счёт",
    "sync.btn.day": "День",
    "sync.btn.week": "Неделя",
    "sync.btn.month": "Месяц",
    "sync.startdate": "Дата начала",
    "sync.reload": "Перезагрузить данные",
    "plots.reload": "Обновить",
    "live.off": "Онлайн выключен.",
    "live.start": "Старт",
    "live.stop": "Стоп",
    "export.dir": "Папка экспорта:",
    "export.btn.excel": "Экспорт Excel",
    "export.range": "Диапазон (необязательно, YYYY-MM-DD):",
    "export.invoice_period": "Период счёта:",
    "export.anchor": "Опорная дата (необязательно):",
    "export.btn.pdf_summary": "Экспорт PDF итоги + графики",
    "export.btn.invoices": "Счета (PDF) по Shelly",
    "export.btn.plots": "Экспорт графиков (дни/недели/месяцы)",
    "export.btn.day_report_v1": "Дневной отчёт PDF (v1)",
    "export.btn.month_report_v1": "Месячный отчёт PDF (v1)",
    "export.btn.current_png": "Текущий вид → PNG",
    "export.btn.current_pdf": "Текущий вид → PDF",
    "period.custom": "Пользовательский",
    "period.day": "День",
    "period.week": "Неделя",
    "period.month": "Месяц",
    "period.year": "Год",
    "settings.save": "Сохранить",
    "settings.reload": "Перезагрузить config",
    "settings.language": "Язык",
    "settings.language.de": "Немецкий",
    "settings.language.en": "Английский",
    "settings.language.es": "Испанский",
    "settings.language.fr": "Французский",
    "settings.language.pt": "Португальский",
    "settings.language.it": "Итальянский",
    "settings.language.pl": "Польский",
    "settings.language.cs": "Чешский",
    "settings.language.ru": "Русский",
    "msg.settings": "Настройки",
    "web.control.title": "Управление Shelly",
})


def get_lang_map(lang: str, prefix: str = None) -> dict:
    """Return merged translations for a language.

    Merge order (fallback):
      1) German (base)
      2) English
      3) requested language

    If `prefix` is given, only keys starting with that prefix are returned.
    """
    lang = normalize_lang(lang)
    merged = {}
    try:
        merged.update(_I18N.get("de", {}))
        merged.update(_I18N.get("en", {}))
        merged.update(_I18N.get(lang, {}))
    except Exception:
        merged = dict(_I18N.get(lang, {}) or {})
    if prefix:
        try:
            merged = {k: v for (k, v) in merged.items() if str(k).startswith(prefix)}
        except Exception:
            pass
    return merged



def t(lang: str, key: str, **kwargs: object) -> str:
    """Translate a key for a language.

    Fallback order:
      1) requested language
      2) English
      3) German
      4) key itself
    """
    lang = normalize_lang(lang)
    s = (
        (_I18N.get(lang, {}) or {}).get(key)
        or (_I18N.get("en", {}) or {}).get(key)
        or (_I18N.get("de", {}) or {}).get(key)
        or key
    )
    try:
        return str(s).format(**kwargs)
    except Exception:
        return str(s)


def normalize_lang(lang: str) -> str:
    lang = (lang or "de").lower().strip()
    return lang if lang in LANGS else "de"



# -------- PDF / Reporting translations --------

_I18N.setdefault("en", {}).update({
    "pdf.period": "Period",
    "pdf.summary": "Summary",
    "pdf.col.name": "Name",
    "pdf.col.cost": "Cost",
    "pdf.col.avg_w": "Avg W",
    "pdf.col.max_w": "Max W",
    "pdf.plot_load_error": "(Could not load plot: {path})",

    "pdf.invoice": "Invoice",
    "pdf.invoice_no": "No.",
    "pdf.date": "Date",
    "pdf.due": "Due",
    "pdf.vat_id": "VAT ID",
    "pdf.email": "Email",
    "pdf.phone": "Phone",
    "pdf.bill_to": "Bill to",

    "pdf.col.description": "Description",
    "pdf.col.quantity": "Quantity",
    "pdf.col.unit_price": "Unit price",
    "pdf.col.amount": "Amount",
    "pdf.subtotal": "Subtotal",
    "pdf.vat": "VAT",
    "pdf.total": "Total",
    "pdf.pay_bank": "Payment by bank transfer to IBAN: {iban}  BIC: {bic}",
    "pdf.pay_by": "Please pay by {due}.",

    "pdf.created": "Created",

    "pdf.report.overall": "Overall overview",
    "pdf.report.overall_continue": "Overall overview (continued)",
    "pdf.report.total_energy": "Total energy",
    "pdf.report.total_cost": "Total cost",
    "pdf.report.peak_total": "Total peak",
    "pdf.col.device": "Device",
    "pdf.col.peak_w": "Peak W",
    "pdf.col.v_minmax": "V min/max",
    "pdf.report.top_hours_total": "Top hours (total)",
    "pdf.report.top_hours_continue": "Top hours (continued)",
    "pdf.col.hour": "Hour",
    "pdf.report.device_overview": "Device overview",
    "pdf.report.energy": "Energy",
    "pdf.report.cost": "Cost",
    "pdf.report.peak": "Peak",
    "pdf.report.v_minmax": "Voltage min/max",
    "pdf.report.top_hours": "Top hours",

    "pdf.pricing.no_vat": "Price: {price} €/kWh (VAT disabled)",
    "pdf.pricing.gross_incl_vat": "Price: {gross} €/kWh incl. VAT ({vat}%) | Net: {net} €/kWh",
    "pdf.pricing.net_excl_vat": "Price: {net} €/kWh excl. VAT ({vat}%) | Gross: {gross} €/kWh",

    "pdf.invoice.line_energy": "Electricity consumption {device} ({period})",
    "pdf.invoice.line_base_fee": "Base fee ({days} days)",

    "unit.days": "days",
    "period.all": "(entire period)",
    "msg.report_written": "Report written",
    "pdf.report.title.day": "Energy Report – Daily report",
    "pdf.report.title.month": "Energy Report – Monthly report",
    "pdf.summary.title": "Shelly Energy Summary",
    "pdf.summary.note": "Gross price: {price} €/kWh{vat_part} – created with Shelly Energy Analyzer {version}",
    "common.to": "to",
})

_I18N.setdefault("de", {}).update({
    "pdf.period": "Zeitraum",
    "pdf.summary": "Zusammenfassung",
    "pdf.col.name": "Name",
    "pdf.col.cost": "€",
    "pdf.col.avg_w": "Ø W",
    "pdf.col.max_w": "Max W",
    "pdf.plot_load_error": "(Plot konnte nicht geladen werden: {path})",

    "pdf.invoice": "Rechnung",
    "pdf.invoice_no": "Nr.",
    "pdf.date": "Datum",
    "pdf.due": "Fällig",
    "pdf.vat_id": "USt-IdNr.",
    "pdf.email": "E-Mail",
    "pdf.phone": "Tel.",
    "pdf.bill_to": "Rechnung an",

    "pdf.col.description": "Beschreibung",
    "pdf.col.quantity": "Menge",
    "pdf.col.unit_price": "Einzelpreis",
    "pdf.col.amount": "Betrag",
    "pdf.subtotal": "Zwischensumme",
    "pdf.vat": "MwSt",
    "pdf.total": "Gesamt",
    "pdf.pay_bank": "Zahlung per Überweisung an IBAN: {iban}  BIC: {bic}",
    "pdf.pay_by": "Bitte zahlen Sie bis spätestens {due}.",

    "pdf.created": "Erstellt",

    "pdf.report.overall": "Gesamtübersicht",
    "pdf.report.overall_continue": "Gesamtübersicht (Fortsetzung)",
    "pdf.report.total_energy": "Gesamtverbrauch",
    "pdf.report.total_cost": "Gesamtkosten",
    "pdf.report.peak_total": "Peak Gesamt",
    "pdf.col.device": "Gerät",
    "pdf.col.peak_w": "Peak W",
    "pdf.col.v_minmax": "V min/max",
    "pdf.report.top_hours_total": "Top-Stunden (Gesamt)",
    "pdf.report.top_hours_continue": "Top-Stunden (Fortsetzung)",
    "pdf.col.hour": "Stunde",
    "pdf.report.device_overview": "Geräteübersicht",
    "pdf.report.energy": "Verbrauch",
    "pdf.report.cost": "Kosten",
    "pdf.report.peak": "Peak",
    "pdf.report.v_minmax": "Spannung min/max",
    "pdf.report.top_hours": "Top-Stunden",

    "pdf.pricing.no_vat": "Preis: {price} €/kWh (MwSt deaktiviert)",
    "pdf.pricing.gross_incl_vat": "Preis: {gross} €/kWh inkl. MwSt ({vat}%) | Netto: {net} €/kWh",
    "pdf.pricing.net_excl_vat": "Preis: {net} €/kWh zzgl. MwSt ({vat}%) | Brutto: {gross} €/kWh",

    "pdf.invoice.line_energy": "Stromverbrauch {device} ({period})",
    "pdf.invoice.line_base_fee": "Grundpreis ({days} Tage)",

    "unit.days": "Tage",
    "period.all": "(gesamter Zeitraum)",
    "msg.report_written": "Report geschrieben",
    "pdf.report.title.day": "Energy Report – Tagesreport",
    "pdf.report.title.month": "Energy Report – Monatsreport",
})



# -------- Extra translation fixes / completeness --------
_I18N.setdefault("de", {}).update({
    "common.error": "Fehler",
    "common.log": "Log",
    "common.no_data": "Keine Daten.",
    "msg.report": "Report",
    "export.err.png_save_title": "Export PNG",
    "export.err.png_save": "Konnte PNG nicht speichern:\n{e}",
    "export.invoice_written": "Rechnung geschrieben: {path}",
    "export.excel_written": "Excel geschrieben: {path}",
    "export.pdf_summary_written": "PDF Summary (inkl. Plots) geschrieben: {path}",
    "pdf.summary.title": "Shelly Energie-Zusammenfassung",
    "pdf.summary.note": "Bruttopreis: {price} €/kWh{vat_part} – erstellt mit Shelly Energy Analyzer {version}",
})

_I18N.setdefault("en", {}).update({
    "common.error": "Error",
    "common.log": "Log",
    "common.no_data": "No data.",
    "msg.report": "Report",
    "export.err.png_save_title": "Export PNG",
    "export.err.png_save": "Could not save PNG:\n{e}",
    "export.invoice_written": "Invoice written: {path}",
    "export.excel_written": "Excel written: {path}",
    "export.pdf_summary_written": "PDF Summary (incl. plots) written: {path}",
})

_I18N.setdefault("es", {}).update({
    "common.error": "Error",
    "common.log": "Registro",
    "common.no_data": "Sin datos.",
    "msg.report": "Informe",
    "export.err.png_save_title": "Exportar PNG",
    "export.err.png_save": "No se pudo guardar el PNG:\n{e}",
    "export.invoice_written": "Factura creada: {path}",
    "export.excel_written": "Excel creado: {path}",
    "export.pdf_summary_written": "Resumen PDF (incl. gráficos) creado: {path}",

    # PDF / reporting (Spanish)
    "pdf.period": "Período",
    "pdf.summary": "Resumen",
    "pdf.col.name": "Nombre",
    "pdf.col.cost": "Coste",
    "pdf.col.avg_w": "Prom W",
    "pdf.col.max_w": "Máx W",
    "pdf.plot_load_error": "(No se pudo cargar el gráfico: {path})",

    "pdf.invoice": "Factura",
    "pdf.invoice_no": "N.º",
    "pdf.date": "Fecha",
    "pdf.due": "Vence",
    "pdf.vat_id": "NIF/IVA",
    "pdf.email": "Email",
    "pdf.phone": "Tel.",
    "pdf.bill_to": "Facturar a",

    "pdf.col.description": "Descripción",
    "pdf.col.quantity": "Cantidad",
    "pdf.col.unit_price": "Precio unit.",
    "pdf.col.amount": "Importe",
    "pdf.subtotal": "Subtotal",
    "pdf.vat": "IVA",
    "pdf.total": "Total",
    "pdf.pay_bank": "Pago por transferencia bancaria a IBAN: {iban}  BIC: {bic}",
    "pdf.pay_by": "Por favor pague antes de {due}.",

    "pdf.created": "Creado",
    "pdf.report.overall": "Resumen general",
    "pdf.report.overall_continue": "Resumen general (continuación)",
    "pdf.report.total_energy": "Energía total",
    "pdf.report.total_cost": "Coste total",
    "pdf.report.peak_total": "Pico total",
    "pdf.col.device": "Dispositivo",
    "pdf.col.peak_w": "Pico W",
    "pdf.col.v_minmax": "V mín/máx",
    "pdf.report.top_hours_total": "Horas pico (total)",
    "pdf.report.top_hours_continue": "Horas pico (continuación)",
    "pdf.col.hour": "Hora",
    "pdf.report.device_overview": "Resumen por dispositivo",
    "pdf.report.energy": "Energía",
    "pdf.report.cost": "Coste",
    "pdf.report.peak": "Pico",
    "pdf.report.v_minmax": "Tensión mín/máx",
    "pdf.report.top_hours": "Horas pico",

    "pdf.pricing.no_vat": "Precio: {price} €/kWh (IVA desactivado)",
    "pdf.pricing.gross_incl_vat": "Precio: {gross} €/kWh IVA incl. ({vat}%) | Neto: {net} €/kWh",
    "pdf.pricing.net_excl_vat": "Precio: {net} €/kWh IVA excl. ({vat}%) | Bruto: {gross} €/kWh",

    "pdf.invoice.line_energy": "Consumo eléctrico {device} ({period})",
    "pdf.invoice.line_base_fee": "Cuota fija ({days} días)",

    "pdf.report.title.day": "Informe de energía – Informe diario",
    "pdf.report.title.month": "Informe de energía – Informe mensual",
    "pdf.summary.title": "Resumen de energía Shelly",
    "pdf.summary.note": "Precio bruto: {price} €/kWh{vat_part} – creado con Shelly Energy Analyzer {version}",
})

# -------- Local formatting helpers (dates/numbers) --------

_DATE_FORMATS = {
    "en": "%Y-%m-%d",
    "fr": "%d/%m/%Y",
    "es": "%d/%m/%Y",
    "pt": "%d/%m/%Y",
    "it": "%d/%m/%Y",
    "de": "%d.%m.%Y",
    "pl": "%d.%m.%Y",
    "cs": "%d.%m.%Y",
    "ru": "%d.%m.%Y",
}

def format_date_local(lang: str, d) -> str:
    """Format a date-like value in a language-local format."""
    lang = normalize_lang(lang)
    fmt = _DATE_FORMATS.get(lang, _DATE_FORMATS["en"])
    if d is None:
        return ""
    try:
        if hasattr(d, "to_pydatetime"):
            d = d.to_pydatetime()
        if hasattr(d, "date") and not isinstance(d, _date):
            d = d.date()
        if isinstance(d, _datetime):
            d = d.date()
        if isinstance(d, _date):
            return d.strftime(fmt)
    except Exception:
        pass
    return str(d)

def format_datetime_local(lang: str, ts, with_seconds: bool = False) -> str:
    """Format a datetime-like value in a language-local format."""
    lang = normalize_lang(lang)
    if ts is None:
        return ""
    try:
        if hasattr(ts, "to_pydatetime"):
            ts = ts.to_pydatetime()
        if isinstance(ts, _date) and not isinstance(ts, _datetime):
            return format_date_local(lang, ts)
        if isinstance(ts, _datetime):
            date_part = format_date_local(lang, ts.date())
            time_part = ts.strftime("%H:%M:%S" if with_seconds else "%H:%M")
            return f"{date_part} {time_part}"
    except Exception:
        pass
    return str(ts)

def format_hour_local(lang: str, ts) -> str:
    """Format an hour start (date + HH:00)."""
    if ts is None:
        return ""
    try:
        if hasattr(ts, "to_pydatetime"):
            ts = ts.to_pydatetime()
        if isinstance(ts, _datetime):
            return f"{format_date_local(lang, ts.date())} {ts.strftime('%H')}:00"
    except Exception:
        pass
    return str(ts)

def format_number_local(lang: str, x: float, decimals: int = 2) -> str:
    """Format a number with local decimal separators."""
    lang = normalize_lang(lang)
    try:
        x = float(x)
    except Exception:
        return str(x)
    s = f"{x:,.{int(decimals)}f}"
    if lang == "en":
        return s
    return s.replace(",", "X").replace(".", ",").replace("X", ".")
